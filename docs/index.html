{% load static %}
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-Z8ZTJQ8LY7"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-Z8ZTJQ8LY7');
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="{% if og_description %}{{ og_description }}{% else %}å°ç£å¥è¡Œåˆ†äº«åœ°åœ–ï¼Œé›†åˆå±±å‹å€‘è²¢ç»çš„æ­¥é“è»Œè·¡ï¼Œè®“å¤§å®¶æ–¹ä¾¿æœç´¢æ­¥é“ã€æ¢ç´¢ç™¾å²³å°ç™¾å²³ï¼Œä¸Šå‚³ GPX å³å¯åˆ†äº«ã€‚{% endif %}">
    <title>{% if og_title %}{{ og_title }}{% else %}å°ç£å¥è¡Œåˆ†äº«åœ°åœ–{% endif %}</title>
    
    <!-- PWA è¨­å®šï¼šéš±è—ç€è¦½å™¨ UI -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="{% static 'manifest.json' %}">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ”ï¸</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ”ï¸</text></svg>">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="{% if og_url %}{{ og_url }}{% else %}https://hroutes.com/{% endif %}">
    <meta property="og:title" content="{% if og_title %}{{ og_title }}{% else %}ğŸ”ï¸ å°ç£å¥è¡Œåˆ†äº«åœ°åœ–{% endif %}">
    <meta property="og:description" content="{% if og_description %}{{ og_description }}{% else %}å°ç£å¥è¡Œåˆ†äº«åœ°åœ–ï¼Œé›†åˆå±±å‹å€‘è²¢ç»çš„æ­¥é“è»Œè·¡ï¼Œè®“å¤§å®¶æ–¹ä¾¿æœç´¢æ­¥é“ã€æ¢ç´¢ç™¾å²³å°ç™¾å²³ï¼Œä¸Šå‚³ GPX å³å¯åˆ†äº«ã€‚{% endif %}">
    <meta property="og:image" content="{% if og_image %}{{ og_image }}{% else %}https://hroutes.com/og/default.png{% endif %}">
    <meta property="og:image:width" content="800">
    <meta property="og:image:height" content="420">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="{% if og_url %}{{ og_url }}{% else %}https://hroutes.com/{% endif %}">
    <meta property="twitter:title" content="{% if og_title %}{{ og_title }}{% else %}ğŸ”ï¸ å°ç£å¥è¡Œåˆ†äº«åœ°åœ–{% endif %}">
    <meta property="twitter:description" content="{% if og_description %}{{ og_description }}{% else %}å°ç£å¥è¡Œåˆ†äº«åœ°åœ–ï¼Œé›†åˆå±±å‹å€‘è²¢ç»çš„æ­¥é“è»Œè·¡ï¼Œè®“å¤§å®¶æ–¹ä¾¿æœç´¢æ­¥é“ã€æ¢ç´¢ç™¾å²³å°ç™¾å²³ï¼Œä¸Šå‚³ GPX å³å¯åˆ†äº«ã€‚{% endif %}">
    <meta property="twitter:image" content="{% if og_image %}{{ og_image }}{% else %}https://hroutes.com/og/default.png{% endif %}">
    
    <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.0.0/dist/maplibre-gl.css" />
    <script src="https://unpkg.com/maplibre-gl@4.0.0/dist/maplibre-gl.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        .sidebar {
            width: 360px;
            height: 100vh;
            background: rgba(255, 255, 255, 0.98);
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            overflow-y: auto;
            z-index: 1000;
        }
        /* ç§»åŠ¨ç«¯é¡¶éƒ¨æ  */
        .mobile-header {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            z-index: 2000;
            padding: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .mobile-header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .mobile-buttons {
            display: flex;
            gap: 8px;
            margin-left: auto;
        }
        .mobile-title {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .mobile-btn {
            padding: 6px 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            white-space: nowrap;
        }
        .mobile-btn:hover {
            background: #5568d3;
        }
        .mobile-upload-btn {
            background: #2c3e50 !important;
        }
        .mobile-upload-btn:hover {
            background: #1a252f !important;
        }
        .mobile-search {
            width: 100%;
        }
        .mobile-search-input-group {
            display: flex;
            gap: 8px;
            align-items: stretch;
        }
        .mobile-search-input-group input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 16px;
            line-height: normal;
        }
        /* æœç´¢èˆ‡æ¢ç´¢æŒ‰éˆ•çµ±ä¸€ä½¿ç”¨ç›¸åŒå°ºå¯¸ï¼ˆèˆ‡ mobile-explore-btn ä¸€è‡´ï¼‰ */
        .mobile-search-input-group .mobile-search-btn {
            padding: 8px 16px !important;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            border: none !important;
            border-radius: 6px !important;
            cursor: pointer;
            font-size: 16px !important;
            font-weight: 600 !important;
            white-space: nowrap !important;
            transition: all 0.3s;
            line-height: normal !important;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .mobile-search-input-group .mobile-search-btn:hover {
            background: linear-gradient(135deg, #5568d3 0%, #6a3f8f 100%) !important;
        }
        .mobile-search-input-group .mobile-search-btn:active {
            transform: scale(0.95);
        }
        /* Dialog */
        .dialog-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }
        .dialog-overlay.show {
            display: flex;
        }
        .dialog {
            background: white;
            border-radius: 12px;
            padding: 20px;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            position: relative;
        }
        .dialog-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4f2e28;
        }
        .dialog-title {
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
        }
        .dialog-close {
            width: 30px;
            height: 30px;
            border: none;
            background: #f0f0f0;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .dialog-close:hover {
            background: #e0e0e0;
        }
        .dialog-content {
            font-size: 14px;
            line-height: 1.6;
            color: #333;
        }
        /* å“åº”å¼ */
        @media (max-width: 1279px) {
            .sidebar {
                display: none;
            }
            .mobile-header {
                display: block;
            }
        }
        @media (min-width: 1281px) {
            .mobile-header {
                display: none;
            }
        }
        .info-panel {
            padding: 20px;
        }
        #map {
            flex: 1;
            height: 100vh;
        }
        .maplibregl-map {
            padding: 50px;
        }
        h1 {
            font-size: 24px;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 3px solid #4f2e28;
        }
        .info-section {
            margin: 20px 0;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .info-item {
            margin: 10px 0;
            font-size: 16px;
            color: white;
            font-weight: 500;
        }
        .info-item strong {
            display: block;
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 4px;
        }
        .legend {
            margin-top: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .legend h3 {
            font-size: 16px;
            margin-bottom: 12px;
            color: #2c3e50;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            font-size: 14px;
        }
        .legend-color {
            width: 30px;
            height: 20px;
            margin-right: 10px;
            border-radius: 3px;
            border: 1px solid #ccc;
        }
        .legend-line {
            width: 30px;
            height: 3px;
            margin-right: 10px;
            border-radius: 2px;
        }
        .legend-dashed {
            width: 30px;
            height: 0;
            margin-right: 10px;
            border-top: 3px dashed;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            background: #28a745;
            color: white;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 10px;
        }
        .search-panel {
            margin-top: 20px;
            padding: 15px;
            background: #fff;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .search-panel h3 {
            font-size: 16px;
            margin-bottom: 12px;
            color: #2c3e50;
        }
        .search-input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        .search-input-group input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 16px;
        }
        .search-input-group button {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }
        .search-input-group button:hover {
            background: #5568d3;
        }
        .search-results {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .search-result-item {
            width: 100%;
            padding: 10px;
            border: none;
            border-bottom: 1px solid #e9ecef;
            background: none;
            text-align: left;
            cursor: pointer;
            transition: background 0.2s;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            user-select: none;
            font-family: inherit;
        }
        .search-result-item:hover {
            background: #f8f9fa;
        }
        .search-result-item:active {
            background: #e9ecef;
        }
        .search-result-item:last-child {
            border-bottom: none;
        }
        .search-result-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 4px;
        }
        .search-result-info {
            font-size: 12px;
            color: #6c757d;
        }
        .search-no-results {
            padding: 20px;
            text-align: center;
            color: #6c757d;
            font-size: 14px;
        }
        
        /* æ­¥é“è³‡è¨Šæ¡† - é è¨­æ¡Œé¢ç«¯ï¼ˆ>= 1280pxï¼‰*/
        .trail-info-panel {
            position: fixed !important;
            bottom: 20px !important;
            right: 20px !important;
            width: 768px !important;
            min-width: 768px !important;
            max-width: 900px !important;
            background: white !important;
            box-shadow: 0 4px 20px rgba(0,0,0,0.25) !important;
            border-radius: 12px !important;
            z-index: 9999 !important;
            overflow: hidden !important;
            display: none !important;
        }
        
        .trail-info-panel.show {
            display: block !important;
        }
        
        .trail-info-header {
            display: flex;
            flex-direction: column;
            padding: 10px 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px 12px 0 0;
            gap: 8px;
            position: relative;
        }
        
        .trail-info-title-row {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            width: 100%;
            padding-right: 70px;
        }
        
        /* å®šä½å›è·¯ç·šæŒ‰éˆ• */
        .trail-center-btn {
            margin-right: -5px;
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.25);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            width: 28px;
            height: 28px;
            flex-shrink: 0;
        }
        
        .trail-center-btn:hover {
            background: rgba(255, 255, 255, 0.35);
            transform: scale(1.05);
        }
        
        .trail-center-btn:active {
            transform: scale(0.95);
        }
        
        .trail-info-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .trail-header-stats {
            display: flex;
            gap: 16px;
            font-size: 14px;
            opacity: 0.95;
            flex-wrap: wrap;
        }
        
        .trail-header-stat {
            white-space: nowrap;
        }
        
        .trail-header-stat span {
            font-weight: 600;
        }
        
        .trail-info-buttons-row {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }
        
        .trail-info-controls {
            position: absolute;
            top: 10px;
            right: 15px;
            display: flex;
            gap: 8px;
        }
        
        .trail-header-stat strong {
            font-weight: 500;
            opacity: 0.8;
        }
        
        .trail-control-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        
        .trail-control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* åˆ†äº«æŒ‰éˆ• */
        .trail-info-buttons-row {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }
        
        .trail-share-btn {
            padding: 6px 12px;
            background: #667eea;
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            white-space: nowrap;
        }
        
        .trail-share-btn:hover {
            background: #5568d3;
            border-color: rgba(255, 255, 255, 0.5);
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
        }
        
        .trail-share-btn svg {
            width: 13px;
            height: 13px;
        }
        
        /* å°å±å¹•ä¸‹æ›´ç·Šæ¹Š */
        @media (max-width: 768px) {
            .trail-share-btn {
                padding: 4px 8px;
                font-size: 10px;
                gap: 2px;
            }
            
            .trail-share-btn svg {
                width: 11px;
                height: 11px;
            }
        }
        
        /* æ¥µå°å±å¹•ï¼ˆå¦‚å°æ–¼ 400pxï¼‰ä¸‹é€²ä¸€æ­¥ç²¾ç°¡ */
        @media (max-width: 400px) {
            .trail-share-btn {
                padding: 4px 6px;
                font-size: 0;
                min-width: 30px;
            }
            
            .trail-share-btn svg {
                margin: 0;
            }
        }
        
        /* åˆ†äº«æˆåŠŸæç¤º */
        .share-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #4caf50;
            color: white;
            padding: 12px 24px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        
        .share-toast.show {
            opacity: 1;
        }
        
        /* ä¸Šå‚³è»Œè·¡æŒ‰éˆ• */
        .upload-trail-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            margin-top: 15px;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        .upload-trail-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .upload-trail-btn svg {
            width: 16px;
            height: 16px;
            vertical-align: middle;
            margin-right: 6px;
        }
        
        /* è¯çµ¡æˆ‘æŒ‰éˆ• */
        .contact-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white !important;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        .contact-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            color: white !important;
        }
        
        /* ä¸Šå‚³è»Œè·¡èªªæ˜æ–‡å­— */
        .upload-trail-desc {
            margin-top: 15px;
            margin-bottom: 10px;
            padding: 12px 14px;
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%);
            border-left: 4px solid #667eea;
            border-radius: 0 8px 8px 0;
            font-size: 14px;
            color: #4a5568;
            line-height: 1.5;
            box-shadow: 0 1px 3px rgba(102, 126, 234, 0.08);
        }
        
        /* ä¸Šå‚³å°è©±æ¡† */
        .upload-dialog-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-group label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }
        
        .form-group input[type="text"] {
            padding: 10px 12px;
            border: 1.5px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        .form-group input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-group input[type="file"] {
            padding: 10px;
            border: 1.5px dashed #ddd;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
        }
        
        .form-group input[type="file"]:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: #f8f9ff;
            border-radius: 6px;
            border: 1px solid #e3e8ff;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .checkbox-group label {
            font-weight: 500;
            color: #2c3e50;
            cursor: pointer;
            margin: 0;
        }
        
        .checkbox-help-text {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
            line-height: 1.5;
        }
        
        .dialog-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .dialog-actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
        
        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #e9ecef;
            color: #495057;
        }
        
        .btn-secondary:hover {
            background: #dee2e6;
        }
        
        /* ä¸Šå‚³æˆåŠŸå°è©±æ¡† */
        .upload-success-info {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .success-icon {
            text-align: center;
            font-size: 48px;
            color: #4caf50;
        }
        
        .share-url-box {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            word-break: break-all;
            font-family: monospace;
            font-size: 13px;
        }
        
        .expiry-notice {
            padding: 12px;
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 6px;
            color: #856404;
            font-size: 13px;
        }
        
        .trail-info-content {
            padding: 12px;
            overflow: hidden;
        }
        
        .trail-elevation-chart {
            background: #ffffff;
            border-radius: 6px;
            padding: 12px;
            border: 1px solid #dee2e6;
        }
        
        #elevationChart {
            width: 100%;
            height: 100px;
            display: block;
            cursor: crosshair;
        }
        
        .elevation-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 11px;
            pointer-events: none;
            z-index: 10000;
            white-space: nowrap;
            display: none;
        }
        
        /* ç•¶å‰ä½ç½®è³‡è¨Šæ¡†ï¼ˆå®šä½æŒ‰éˆ•å·¦å´ï¼‰ */
        .location-info-panel {
            position: absolute;
            top: 10px;
            right: 52px;
            background: rgba(0, 0, 0, 0.82);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            line-height: 1.5;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            pointer-events: none;
        }
        .location-info-panel .loc-row {
            white-space: nowrap;
        }
        .location-info-panel .loc-hint {
            font-size: 11px;
            opacity: 0.9;
        }
        /* å°è¢å¹•ï¼šåœ°åœ–å·¦å´ï¼Œèˆ‡æŒ‰éˆ•ç­‰é«˜ */
        @media (max-width: 1279px) {
            .location-info-panel {
                top: 105px;
                right: auto;
                left: 10px;
            }
        }
        
        /* æ¸¬é‡æŒ‰éˆ•èˆ‡å®šä½æŒ‰éˆ•ç­‰å¤§ */
        .maplibregl-ctrl-top-right .maplibregl-ctrl-group button {
            width: 29px !important;
            height: 29px !important;
            min-width: 29px;
            min-height: 29px;
        }
        
        /* å°è¢å¹•æ™‚ï¼Œåœ°åœ–æ§ä»¶ä¸‹ç§»é¿å…è¢« mobile-header é®æ“‹ */
        @media (max-width: 1279px) {
            .maplibregl-ctrl-top-right {
                top: 100px !important;
            }
        }
        .maplibregl-ctrl-measure button {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .maplibregl-ctrl-measure .maplibregl-ctrl-icon {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        .maplibregl-ctrl-measure button.active {
            background: #667eea;
            color: white;
        }
        
        /* ç­‰é«˜ç·šæŒ‰éˆ• active ç‹€æ…‹ */
        .maplibregl-ctrl-contour button.active {
            background: #42a5f5;
        }
        
        /* æ¸¬é‡è³‡è¨Šæ¡†ï¼ˆåœ°åœ–æ­£ä¸‹æ–¹ï¼‰ */
        .measure-info-panel {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            min-width: 280px;
            max-width: 90%;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            padding: 12px 16px;
            z-index: 1000;
            display: none;
        }
        .measure-info-panel.show {
            display: block;
        }
        .measure-info-panel .measure-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        .measure-info-panel .measure-title {
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
        }
        .measure-info-panel .measure-close {
            width: 24px;
            height: 24px;
            border: none;
            background: #f0f0f0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            padding: 0;
            color: #666;
        }
        .measure-info-panel .measure-close:hover {
            background: #e0e0e0;
            color: #333;
        }
        .measure-info-panel .measure-hint {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
            line-height: 1.4;
        }
        .measure-info-panel .measure-points {
            font-size: 13px;
            color: #333;
            max-height: 120px;
            overflow-y: auto;
        }
        .measure-info-panel .measure-total {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #eee;
            font-size: 14px;
            font-weight: 600;
            color: #667eea;
        }
        
        /* æœ€å°åŒ–ç‹€æ…‹æŒ‰éˆ• */
        .trail-minimized-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: none;
            flex-direction: column;
            gap: 10px;
            z-index: 1600;
        }
        
        .trail-minimized-controls.show {
            display: flex;
        }
        
        .trail-minimized-btn {
            width: 50px;
            height: 50px;
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        
        .trail-minimized-btn:hover {
            background: #667eea;
            color: white;
            transform: scale(1.05);
        }
        
        /* iPad å°ºå¯¸ (768px - 1279px): ç½®ä¸­é¡¯ç¤ºï¼Œå¯¬åº¦ç´„ 90-95% */
        @media (min-width: 768px) and (max-width: 1279px) {
            .trail-info-panel {
                bottom: 20px;
                left: 50% !important;
                right: auto !important;
                transform: translateX(-50%);
                width: 95% !important;
                min-width: unset !important;
                max-width: 750px !important;
            }
            
            .trail-minimized-controls {
                left: 50%;
                right: auto;
                transform: translateX(-50%);
            }
        }
        
        /* æ‰‹æ©Ÿå°ºå¯¸ (< 768px): å·¦å³å„ 10px */
        @media (max-width: 767px) {
            .trail-info-panel {
                bottom: 10px;
                right: 10px;
                left: 10px;
                width: auto !important;
                min-width: unset !important;
                max-width: calc(100vw - 20px) !important;
            }
            
            .trail-minimized-controls {
                right: 10px;
            }
            
            .trail-share-btn {
                padding: 5px 10px;
                font-size: 11px;
            }
            
            #elevationChart {
                height: 90px;
            }
            
            .trail-info-header {
                padding: 8px 12px;
                gap: 6px;
            }
            
            .trail-info-header h3 {
                font-size: 13px;
            }
            
            .trail-info-title-row {
                gap: 8px;
                padding-right: 60px;
            }
            
            .trail-header-stats {
                font-size: 10px;
                gap: 8px;
            }
            
            .trail-info-buttons-row {
                gap: 4px;
            }
            
            .trail-info-controls {
                top: 8px;
                right: 12px;
            }
            
            .trail-control-btn {
                width: 24px;
                height: 24px;
                font-size: 14px;
            }
        }
        
        /* æ¢ç´¢æŒ‰éˆ•æ¨£å¼ */
        .explore-buttons {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .explore-btn {
            padding: 12px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        .explore-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .explore-btn.baiyue {
            background: linear-gradient(135deg, #E53935 0%, #D32F2F 100%);
            box-shadow: 0 2px 8px rgba(229, 57, 53, 0.3);
        }
        
        .explore-btn.baiyue:hover {
            box-shadow: 0 4px 12px rgba(229, 57, 53, 0.4);
        }
        
        .explore-btn.small-baiyue {
            background: linear-gradient(135deg, #43A047 0%, #2E7D32 100%);
            box-shadow: 0 2px 8px rgba(67, 160, 71, 0.3);
        }
        
        .explore-btn.small-baiyue:hover {
            box-shadow: 0 4px 12px rgba(67, 160, 71, 0.4);
        }
        
        .explore-btn.nearby {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
        }
        
        .explore-btn.nearby:hover {
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }
        
        /* ç§»å‹•ç«¯æ¢ç´¢æŒ‰éˆ• */
        .mobile-explore-btn {
            padding: 8px 16px !important;
            background: linear-gradient(135deg, #FF6F00 0%, #F57C00 100%) !important;
            color: white !important;
            border: none !important;
            border-radius: 6px !important;
            cursor: pointer;
            font-size: 16px !important;
            font-weight: 600 !important;
            transition: all 0.3s;
            white-space: nowrap !important;
            line-height: normal !important;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .mobile-explore-btn:active {
            transform: scale(0.95);
        }
        
        .mobile-explore-btn:hover {
            background: linear-gradient(135deg, #F57C00 0%, #E64A19 100%) !important;
        }
        
        .mobile-explore-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 5px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 3000;
            display: none;
            min-width: 150px;
        }
        
        .mobile-explore-dropdown.show {
            display: block;
        }
        
        .mobile-explore-option {
            padding: 12px 16px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            border-bottom: 1px solid #eee;
            transition: background 0.2s;
        }
        
        .mobile-explore-option:last-child {
            border-bottom: none;
        }
        
        .mobile-explore-option:hover {
            background: #f5f5f5;
        }
        
        .mobile-explore-option.baiyue {
            color: #E53935;
        }
        
        .mobile-explore-option.small-baiyue {
            color: #43A047;
        }
        
        .mobile-explore-option.nearby {
            color: #2196F3;
        }
        
        /* è·¯ç·šåˆ—è¡¨å°è©±æ¡† */
        .trails-list-dialog {
            /* ç§»é™¤æ»¾å‹•æ¢ï¼Œæ”¹ç”¨åˆ†é  */
        }
        
        .trail-list-item {
            padding: 9px 16px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            min-height: 36px;
        }
        
        .trail-list-item:hover {
            background: #f5f5f5;
        }
        
        .trail-list-item.active {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }
        
        .trail-list-item-name {
            font-size: 12.5px;
            font-weight: 500;
            color: #2c3e50;
            line-height: 1.4;
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .trail-list-item-index {
            font-size: 10.5px;
            color: #999;
            white-space: nowrap;
        }
        
        /* åˆ†é æ§ä»¶ */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            border-top: 1px solid #eee;
            background: #fafafa;
        }
        
        .pagination-btn {
            padding: 6px 14px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .pagination-btn:hover:not(:disabled) {
            background: #5568d3;
        }
        
        .pagination-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .pagination-info {
            font-size: 13px;
            color: #666;
            font-weight: 500;
            min-width: 50px;
            text-align: center;
        }
        
        /* è·¯ç·šå°èˆªæŒ‰éˆ• */
        .trail-navigation {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .trail-nav-btn {
            flex: 1;
            padding: 10px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .trail-nav-btn:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-1px);
        }
        
        .trail-nav-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .trail-nav-btn svg {
            width: 16px;
            height: 16px;
        }
        
        @media (max-width: 1279px) {
            .explore-buttons {
                display: none;
            }
        }
        
        @media (min-width: 1280px) {
            .mobile-explore-btn {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- ç§»åŠ¨ç«¯é¡¶éƒ¨æ  -->
    <div class="mobile-header">
        <div class="mobile-header-top">
            <div class="mobile-title">
                <span>ğŸ”ï¸å°ç£å¥è¡Œåˆ†äº«åœ°åœ–</span>
            </div>
            <div class="mobile-buttons">
                <button class="mobile-btn" onclick="showUsageDialog()">ä½¿ç”¨èªªæ˜</button>
                <button class="mobile-btn mobile-upload-btn" onclick="showUploadDialog()">ä¸Šå‚³è»Œè·¡</button>
            </div>
        </div>
        <div class="mobile-search">
            <div class="mobile-search-input-group">
                <input type="text" id="mobile-peak-search-input" placeholder="è¼¸å…¥å±±é ­/æ­¥é“åç¨±å®šä½..." />
                <button class="mobile-search-btn" onclick="searchPeaksMobile()">æœç´¢</button>
                <div style="position: relative; display: flex;">
                    <button class="mobile-explore-btn" onclick="toggleMobileExploreDropdown()">æ¢ç´¢</button>
                    <div class="mobile-explore-dropdown" id="mobile-explore-dropdown">
                        <div class="mobile-explore-option baiyue" onclick="showTrailsDialog('baiyue'); toggleMobileExploreDropdown()">
                            ğŸ”ï¸ æ¢ç´¢ ç™¾å²³
                        </div>
                        <div class="mobile-explore-option small-baiyue" onclick="showTrailsDialog('small-baiyue'); toggleMobileExploreDropdown()">
                            â›°ï¸ æ¢ç´¢ å°ç™¾å²³
                        </div>
                        <div class="mobile-explore-option nearby" onclick="showNearbyTrailsDialog(); toggleMobileExploreDropdown()">
                            ğŸ“ æ¢ç´¢ é™„è¿‘æ­¥é“
                        </div>
                    </div>
                </div>
            </div>
            <div id="mobile-search-results" class="search-results" style="display: none; margin-top: 10px;"></div>
        </div>
    </div>

    <!-- Dialog: ä½¿ç”¨èªªæ˜ -->
    <div id="usage-dialog" class="dialog-overlay" onclick="closeDialogOnOverlay(event, 'usage-dialog')">
        <div class="dialog" onclick="event.stopPropagation()">
            <div class="dialog-header">
                <div class="dialog-title">ğŸ“ ä½¿ç”¨èªªæ˜</div>
                <button class="dialog-close" onclick="closeDialog('usage-dialog')">Ã—</button>
            </div>
            <div class="dialog-content">
                <!-- <p style="margin-top: 10px;">åœ¨æœç´¢æ¬„è¼¸å…¥å±±é ­æˆ–æ­¥é“åç¨±ï¼Œé»æ“Šæœç´¢æŒ‰éˆ•å³å¯æ‰¾åˆ°ä¸¦å®šä½ã€‚</p> -->
                <p class="upload-trail-desc" style="margin-top: 14px; margin-bottom: 0;">ğŸ“¤ ä¸Šå‚³è»Œè·¡ï¼Œç”¢ç”ŸçŸ­é€£çµï¼Œèˆ‡åŒä¼´åˆ†äº«</p>
                
                <h3 style="margin-top: 20px; margin-bottom: 12px; color: #2c3e50; font-size: 16px;">åœ–ä¾‹èªªæ˜</h3>
                <div class="legend-item">
                    <div class="legend-line" style="background: #888888;"></div>
                    <span>æ­¥é“ - é‹ªè¨­è·¯é¢<br></span>
                </div>
                <div class="legend-item">
                    <div class="legend-dashed" style="border-color: #ff5722;"></div>
                    <span>æ­¥é“ - æœªé‹ªè¨­è·¯é¢<br></span>
                </div>
                <div class="legend-item">
                    <div class="legend-line" style="background: hsl(205, 56%, 80%);"></div>
                    <span>æ²³æµ</span>
                </div>
                <div class="legend-item">
                    <div style="width: 30px; height: 30px; margin-right: 10px; display: flex; align-items: center; justify-content: center;">
                        <svg viewBox="0 0 24 24" width="18" height="18"><path fill="#8B4513" d="M14 6l-3.75 5 2.85 3.8-1.6 1.2C9.81 13.75 7 10 7 10l-6 8h22L14 6z"/></svg>
                    </div>
                    <span>å±±é ­ (Peak)</span>
                </div>
                <div class="legend-item">
                    <div style="width: 30px; height: 30px; margin-right: 10px; display: flex; align-items: center; justify-content: center;">
                        <svg viewBox="0 0 24 24" width="18" height="18"><path fill="#1E3A8A" d="M12 3L2 12h3v8h14v-8h3L12 3z"/></svg>
                    </div>
                    <span>å±±å±‹ (Hut)</span>
                </div>
                <div class="legend-item">
                    <div style="width: 30px; height: 30px; margin-right: 10px; display: flex; align-items: center; justify-content: center;">
                        <svg viewBox="0 0 24 24" width="18" height="18"><path fill="#155724" d="M4 18l8-14 8 14H4z"/></svg>
                    </div>
                    <span>éœ²ç‡Ÿåœ° (Campsite)</span>
                </div>
                <div class="legend-item">
                    <div style="width: 30px; height: 30px; margin-right: 10px; display: flex; align-items: center; justify-content: center;">
                        <svg viewBox="0 0 24 24" width="18" height="18"><path fill="#D97706" d="M12 3L2 12h20L12 3z"/></svg>
                    </div>
                    <span>é¿é›£æ‰€ (Shelter)</span>
                </div>

                <h3 style="margin-top: 20px; margin-bottom: 12px; color: #2c3e50; font-size: 16px;">è¯çµ¡æˆ‘</h3>
                <a href="mailto:jason@kosbrother.com" class="contact-btn" style="display: inline-flex; align-items: center; padding: 10px 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px; text-decoration: none; font-weight: 500; margin-bottom: 8px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16" style="margin-right: 8px;">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                        <polyline points="22,6 12,13 2,6"></polyline>
                    </svg>
                    è¯çµ¡æˆ‘
                </a>
            </div>
        </div>
    </div>

    <!-- Dialog: ä¸Šå‚³è»Œè·¡ -->
    <div id="upload-dialog" class="dialog-overlay" onclick="closeDialogOnOverlay(event, 'upload-dialog')">
        <div class="dialog" onclick="event.stopPropagation()">
            <div class="dialog-header">
                <div class="dialog-title">ğŸ“¤ ä¸Šå‚³/åˆ†äº«è»Œè·¡</div>
                <button class="dialog-close" onclick="closeDialog('upload-dialog')">Ã—</button>
            </div>
            <div class="dialog-content">
                <form id="upload-trail-form" class="upload-dialog-form" onsubmit="handleTrailUpload(event)">
                    <div class="form-group">
                        <label for="trail-name-input">æ­¥é“(è»Œè·¡)åç¨± *</label>
                        <input 
                            type="text" 
                            id="trail-name-input" 
                            name="trail_name"
                            placeholder="ä¾‹å¦‚ï¼šé¦¬èƒå¤é“" 
                            required
                        />
                    </div>
                    
                    <div class="form-group">
                        <label for="gpx-file-input">GPX æª”æ¡ˆ *</label>
                        <input 
                            type="file" 
                            id="gpx-file-input" 
                            name="gpx_file"
                            accept=".gpx"
                            required
                        />
                        <div class="checkbox-help-text">è«‹é¸æ“‡ .gpx æ ¼å¼çš„è»Œè·¡æª”æ¡ˆ</div>
                    </div>
                    
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input 
                                type="checkbox" 
                                id="permanent-storage-checkbox" 
                                name="request_permanent"
                            />
                            <label for="permanent-storage-checkbox">
                                è«‹æ±‚é•·ä¹…æ”¶éŒ„
                            </label>
                        </div>
                        <div class="checkbox-help-text">
                            âœ“ å‹¾é¸ï¼šæäº¤å¯©æ ¸ï¼Œé€šéå¾Œå°‡æ°¸ä¹…ä¿å­˜åœ¨åœ°åœ–ä¸­<br>
                            âœ— ä¸å‹¾é¸ï¼šç”¢ç”Ÿè‡¨æ™‚åˆ†äº«é€£çµï¼Œä¿ç•™ 30 å¤©
                        </div>
                    </div>
                    
                    <div class="dialog-actions">
                        <button type="button" class="btn-secondary" onclick="closeDialog('upload-dialog')">
                            å–æ¶ˆ
                        </button>
                        <button type="submit" class="btn-primary" id="upload-submit-btn">
                            ä¸Šå‚³
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Dialog: ä¸Šå‚³æˆåŠŸ -->
    <div id="upload-success-dialog" class="dialog-overlay" onclick="closeDialogOnOverlay(event, 'upload-success-dialog')">
        <div class="dialog" onclick="event.stopPropagation()">
            <div class="dialog-header">
                <div class="dialog-title">âœ… ä¸Šå‚³æˆåŠŸ</div>
                <button class="dialog-close" onclick="closeDialog('upload-success-dialog')">Ã—</button>
            </div>
            <div class="dialog-content">
                <div class="upload-success-info" id="upload-success-content">
                    <!-- å‹•æ…‹å¡«å……å…§å®¹ -->
                </div>
                <div class="dialog-actions">
                    <button type="button" class="btn-primary" onclick="closeDialog('upload-success-dialog')" style="width: 100%;">
                        é—œé–‰
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Dialog: è·¯ç·šåˆ—è¡¨ -->
    <div id="trails-list-dialog" class="dialog-overlay" onclick="closeDialogOnOverlay(event, 'trails-list-dialog')">
        <div class="dialog" onclick="event.stopPropagation()" style="max-width: 550px; padding: 0; max-height: 70vh;">
            <div class="dialog-header" style="padding: 15px 20px; margin-bottom: 0;">
                <div class="dialog-title" id="trails-dialog-title">è·¯ç·šåˆ—è¡¨</div>
                <button class="dialog-close" onclick="closeTrailsDialog()">Ã—</button>
            </div>
            <div class="dialog-content" style="padding: 0;">
                <div id="trails-list-content" class="trails-list-dialog">
                    <!-- å‹•æ…‹å¡«å……è·¯ç·šåˆ—è¡¨ -->
                </div>
                <!-- åˆ†é æ§ä»¶ -->
                <div class="pagination" id="trails-pagination" style="display: none;">
                    <button class="pagination-btn" id="prev-page-btn" onclick="changePage(-1)">
                        â† ä¸Šä¸€é 
                    </button>
                    <span class="pagination-info" id="pagination-info">1 / 1</span>
                    <button class="pagination-btn" id="next-page-btn" onclick="changePage(1)">
                        ä¸‹ä¸€é  â†’
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="sidebar" id="sidebar">
        <div class="info-panel">
            <h1>ğŸ”ï¸å°ç£å¥è¡Œåˆ†äº«åœ°åœ–</h1>
            
            <!-- æœç´¢é¢æ¿ -->
            <div class="search-panel">
                <h3>ğŸ” æœç´¢å±±é ­èˆ‡æ­¥é“</h3>
                <div class="search-input-group">
                    <input type="text" id="peak-search-input" placeholder="è¼¸å…¥å±±é ­/æ­¥é“åç¨±å®šä½..." />
                    <button onclick="searchPeaks()">æœç´¢</button>
                </div>
                <div id="search-results" class="search-results" style="display: none;"></div>
            </div>
            
            <!-- ä¸Šå‚³è»Œè·¡å€å¡Š -->
            <button class="upload-trail-btn" onclick="showUploadDialog()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                ä¸Šå‚³/åˆ†äº«è»Œè·¡
            </button>
            <p class="upload-trail-desc">ğŸ“¤ èªªæ˜ï¼šä¸Šå‚³è»Œè·¡ï¼Œç”¢ç”ŸçŸ­é€£çµï¼Œèˆ‡åŒä¼´åˆ†äº«</p>

            <!-- æ¢ç´¢æŒ‰éˆ• -->
            <div class="explore-buttons">
                <button class="explore-btn baiyue" onclick="showTrailsDialog('baiyue')">
                    ğŸ”ï¸ æ¢ç´¢ ç™¾å²³
                </button>
                <button class="explore-btn small-baiyue" onclick="showTrailsDialog('small-baiyue')">
                    â›°ï¸ æ¢ç´¢ å°ç™¾å²³
                </button>
                <button class="explore-btn nearby" onclick="showNearbyTrailsDialog()">
                    ğŸ“ æ¢ç´¢ é™„è¿‘æ­¥é“
                </button>
            </div>

            <!-- è¯çµ¡æˆ‘ -->
            <div class="contact-section" style="margin-top: 20px; padding-top: 16px; border-top: 1px solid #eee;">
                <a href="mailto:jason@kosbrother.com" class="contact-btn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16" style="vertical-align: middle; margin-right: 6px;">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                        <polyline points="22,6 12,13 2,6"></polyline>
                    </svg>
                    è¯çµ¡æˆ‘
                </a>
            </div>

            <div class="legend">
                <h3>åœ–ä¾‹èªªæ˜</h3>
                <div class="legend-item">
                    <div class="legend-line" style="background: #888888;"></div>
                    <span>æ­¥é“ - é‹ªè¨­è·¯é¢<br></span>
                </div>
                <div class="legend-item">
                    <div class="legend-dashed" style="border-color: #ff5722;"></div>
                    <span>æ­¥é“ - æœªé‹ªè¨­è·¯é¢<br></span>
                </div>
                <div class="legend-item">
                    <div class="legend-line" style="background: hsl(205, 56%, 80%);"></div>
                    <span>æ²³æµ</span>
                </div>
                <div class="legend-item">
                    <div style="width: 30px; height: 30px; margin-right: 10px; display: flex; align-items: center; justify-content: center;">
                        <svg viewBox="0 0 24 24" width="18" height="18"><path fill="#8B4513" d="M14 6l-3.75 5 2.85 3.8-1.6 1.2C9.81 13.75 7 10 7 10l-6 8h22L14 6z"/></svg>
                    </div>
                    <span>å±±é ­ (Peak)</span>
                </div>
                <div class="legend-item">
                    <div style="width: 30px; height: 30px; margin-right: 10px; display: flex; align-items: center; justify-content: center;">
                        <svg viewBox="0 0 24 24" width="18" height="18"><path fill="#1E3A8A" d="M12 3L2 12h3v8h14v-8h3L12 3z"/></svg>
                    </div>
                    <span>å±±å±‹ (Hut)</span>
                </div>
                <div class="legend-item">
                    <div style="width: 30px; height: 30px; margin-right: 10px; display: flex; align-items: center; justify-content: center;">
                        <svg viewBox="0 0 24 24" width="18" height="18"><path fill="#155724" d="M4 18l8-14 8 14H4z"/></svg>
                    </div>
                    <span>éœ²ç‡Ÿåœ° (Campsite)</span>
                </div>
                <div class="legend-item">
                    <div style="width: 30px; height: 30px; margin-right: 10px; display: flex; align-items: center; justify-content: center;">
                        <svg viewBox="0 0 24 24" width="18" height="18"><path fill="#D97706" d="M12 3L2 12h20L12 3z"/></svg>
                    </div>
                    <span>é¿é›£æ‰€ (Shelter)</span>
                </div>
            </div>

            
        </div>
    </div>
    
    <div id="map"></div>

    <!-- æ­¥é“è³‡è¨Šæ¡† -->
    <div id="trail-info-panel" class="trail-info-panel">
        <div class="trail-info-header">
            <!-- ç¬¬ä¸€åˆ—ï¼šå®šä½æŒ‰éˆ• + æ­¥é“åç¨± + è·é›¢ -->
            <div class="trail-info-title-row">
                <button class="trail-center-btn" id="trail-center-btn" onclick="centerMapOnTrail()" title="å®šä½å›è·¯ç·šä¸­å¿ƒ" style="display: none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="width: 16px; height: 16px;">
                        <circle cx="12" cy="12" r="10"></circle>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                </button>
                <h3 id="trail-info-title">æ­¥é“è³‡è¨Š</h3>
                <span id="trail-distance-from-user" style="font-size: 13px; opacity: 0.9;"></span>
            </div>
            <!-- ç¬¬äºŒåˆ—ï¼šçµ±è¨ˆä¿¡æ¯ -->
            <div class="trail-header-stats">
                <span class="trail-header-stat">é•·åº¦ <span id="trail-length-header">--</span> km</span>
                <span class="trail-header-stat">çˆ¬å‡ <span id="trail-ascent-header">--</span> m</span>
                <span class="trail-header-stat">ä¸‹é™ <span id="trail-descent-header">--</span> m</span>
            </div>
            <!-- ç¬¬ä¸‰åˆ—ï¼šæŒ‰éˆ• -->
            <div class="trail-info-buttons-row">
                <button class="trail-share-btn" id="share-trail-btn" onclick="shareTrail()" title="åˆ†äº«æ­¤æ­¥é“" style="display: none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="18" cy="5" r="3"></circle>
                        <circle cx="6" cy="12" r="3"></circle>
                        <circle cx="18" cy="19" r="3"></circle>
                        <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                        <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                    </svg>
                    åˆ†äº«
                </button>
                <button class="trail-share-btn" id="download-gpx-btn" onclick="downloadTrailGPX()" title="ä¸‹è¼‰ GPX" style="display: none; background: #4caf50;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    ä¸‹è¼‰ GPX
                </button>
                <!-- è·¯ç·šå°èˆªæŒ‰éˆ•ï¼ˆæ¢ç´¢ç™¾å²³/å°ç™¾å²³æ™‚é¡¯ç¤ºï¼‰ -->
                <button class="trail-share-btn" id="prev-trail-info-btn" onclick="navigateTrailInPanel(-1)" title="ä¸Šä¸€æ¢è·¯ç·š" style="display: none; background: #667eea;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                    ä¸Šä¸€æ¢æ­¥é“
                </button>
                <button class="trail-share-btn" id="next-trail-info-btn" onclick="navigateTrailInPanel(1)" title="ä¸‹ä¸€æ¢è·¯ç·š" style="display: none; background: #667eea;">
                    ä¸‹ä¸€æ¢æ­¥é“
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </button>
            </div>
            <div class="trail-info-controls">
                <button class="trail-control-btn" onclick="minimizeTrailPanel(event)" id="minimize-btn" title="æ”¶ç¸®">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="4 14 10 14 10 20"></polyline>
                        <polyline points="20 10 14 10 14 4"></polyline>
                        <line x1="14" y1="10" x2="21" y2="3"></line>
                        <line x1="3" y1="21" x2="10" y2="14"></line>
                    </svg>
                </button>
                <button class="trail-control-btn" onclick="closeTrailPanel(event)" title="é—œé–‰">âœ•</button>
            </div>
        </div>
        <div class="trail-info-content">
            <div class="trail-elevation-chart">
                <canvas id="elevationChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- åˆ†äº«æˆåŠŸæç¤º -->
    <div id="share-toast" class="share-toast">âœ“ é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿</div>

    <!-- æœ€å°åŒ–ç‹€æ…‹æŒ‰éˆ• -->
    <div id="trail-minimized-controls" class="trail-minimized-controls">
        <button class="trail-minimized-btn" onclick="restoreTrailPanel()" title="å±•é–‹">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 3 21 3 21 9"></polyline>
                <polyline points="9 21 3 21 3 15"></polyline>
                <line x1="21" y1="3" x2="14" y2="10"></line>
                <line x1="3" y1="21" x2="10" y2="14"></line>
            </svg>
        </button>
        <button class="trail-minimized-btn" onclick="closeTrailPanelCompletely()" title="é—œé–‰">âœ•</button>
    </div>

    <script>
        // ============================================
        // é˜²æ­¢ iOS è‡ªåŠ¨ç¼©æ”¾å’Œæ‰‹åŠ¿ç¼©æ”¾
        // ============================================
        window.onload = function () {
            // é˜»æ­¢æ‰‹åŠ¿ç¼©æ”¾
            document.addEventListener('gesturestart', function (e) {
                e.preventDefault();
            });
            // é˜»æ­¢åŒå‡»æ”¾å¤§
            document.addEventListener('dblclick', function (e) {
                e.preventDefault();
            });
            // é˜»æ­¢åŒæŒ‡ç¼©æ”¾
            let lastTouchEnd = 0;
            document.addEventListener('touchstart', function (event) {
                if (event.touches.length > 1) {
                    event.preventDefault();
                }
            });
            document.addEventListener('touchend', function (event) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
        };

        // ============================================
        // Dialog æ§åˆ¶
        // ============================================
        function showDialog(dialogId) {
            const dialog = document.getElementById(dialogId);
            if (dialog) {
                dialog.classList.add('show');
                document.body.style.overflow = 'hidden';
            }
        }

        function showUsageDialog() {
            showDialog('usage-dialog');
        }

        function closeDialog(dialogId) {
            const dialog = document.getElementById(dialogId);
            if (dialog) {
                dialog.classList.remove('show');
                dialog.style.display = 'none';
                document.body.style.overflow = '';
            }
        }

        function closeDialogOnOverlay(event, dialogId) {
            if (event.target.classList.contains('dialog-overlay')) {
                closeDialog(dialogId);
            }
        }

        // ESC é”®å…³é—­ dialog
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.dialog-overlay.show').forEach(dialog => {
                    dialog.classList.remove('show');
                    document.body.style.overflow = '';
                });
            }
        });

        // åˆå§‹åŒ–åœ°å›¾
        // åŠ¨æ€æ„å»º tiles URLï¼ˆè‡ªåŠ¨æ£€æµ‹æœ¬åœ°/è¿œç¨‹ç¯å¢ƒï¼‰
        let tilesBaseUrl;
        const hostname = window.location.hostname;
        const port = window.location.port;
        
        // æœ¬åœ°å¼€å‘ç¯å¢ƒï¼šç›´æ¥ä½¿ç”¨ tileserver ç«¯å£
        if (hostname === 'localhost' || hostname === '127.0.0.1') {
            tilesBaseUrl = 'http://localhost:8080/data/v3';
        } else {
            // ç”Ÿäº§ç¯å¢ƒï¼šä½¿ç”¨ nginx ä»£ç†
            tilesBaseUrl = window.location.origin + '/tiles/data/v3';
        }
        
        const map = new maplibregl.Map({
            container: 'map',
            maxTileCacheSize: 50,
            maxBounds: [[116.0, 20.5], [124.5, 26.5]],
            style: {
                version: 8,
                name: 'OpenTrailMap Taiwan',
                glyphs: 'https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf',
                sources: {
                    'openmaptiles': {
                        type: 'vector',
                        tiles: [tilesBaseUrl + '/{z}/{x}/{y}.pbf'],
                        minzoom: 7,
                        maxzoom: 14,
                        tolerance: 5
                    }
                },
                layers: [
                    {
                        id: 'background',
                        type: 'background',
                        paint: {'background-color': '#F2EADA'}
                    },
                    {
                        id: 'landuse-exclusion',
                        type: 'fill',
                        source: 'openmaptiles',
                        'source-layer': 'landuse',
                        filter: [
                            'all',
                            ['==', '$type', 'Polygon'],
                            ['in', 'class', 'military']
                        ],
                        layout: {visibility: 'visible'},
                        paint: {'fill-color': '#f0f0f0', 'fill-opacity': 0.5}
                    },
                    {
                        id: 'water',
                        type: 'fill',
                        source: 'openmaptiles',
                        'source-layer': 'water',
                        minzoom: 0,
                        layout: {visibility: 'visible'},
                        paint: {'fill-color': 'hsl(205, 56%, 87%)'}
                    },
                    {
                        id: 'water_intermittent',
                        type: 'fill',
                        source: 'openmaptiles',
                        'source-layer': 'water',
                        filter: ['all', ['==', '$type', 'Polygon'], ['==', 'intermittent', 1]],
                        layout: {visibility: 'visible'},
                        paint: {'fill-color': 'hsl(205, 56%, 87%)', 'fill-opacity': 0.7}
                    },
                    {
                        id: 'water-outline',
                        type: 'line',
                        source: 'openmaptiles',
                        'source-layer': 'water',
                        filter: [
                            'all',
                            ['==', '$type', 'Polygon'],
                            ['!=', 'brunnel', 'tunnel']
                        ],
                        layout: {visibility: 'visible'},
                        paint: {'line-color': 'hsl(205, 56%, 80%)', 'line-width': 0.75}
                    },
                    {
                        id: 'landcover-ice-shelf',
                        type: 'fill',
                        source: 'openmaptiles',
                        'source-layer': 'landcover',
                        filter: ['==', 'subclass', 'ice_shelf'],
                        layout: {visibility: 'visible'},
                        paint: {'fill-color': 'hsl(47, 26%, 88%)', 'fill-opacity': 0.8}
                    },
                    {
                        id: 'landcover-glacier',
                        type: 'fill',
                        source: 'openmaptiles',
                        'source-layer': 'landcover',
                        filter: ['==', 'subclass', 'glacier'],
                        layout: {visibility: 'visible'},
                        paint: {
                            'fill-color': 'hsl(47, 22%, 94%)',
                            'fill-opacity': {base: 1, stops: [[0, 1], [8, 0.5]]}
                        }
                    },
                    {
                        id: 'landcover-wood',
                        type: 'fill',
                        source: 'openmaptiles',
                        'source-layer': 'landcover',
                        filter: ['in', 'class', 'wood', 'forest'],
                        minzoom: 8,
                        layout: {visibility: 'visible'},
                        paint: {
                            'fill-color': '#c8e6c8',
                            'fill-opacity': {base: 1, stops: [[8, 0.4], [12, 0.6], [16, 0.7]]}
                        }
                    },
                    {
                        id: 'landcover-grass',
                        type: 'fill',
                        source: 'openmaptiles',
                        'source-layer': 'landcover',
                        filter: ['in', 'class', 'grass', 'scrub', 'grassland'],
                        minzoom: 10,
                        layout: {visibility: 'visible'},
                        paint: {
                            'fill-color': '#d4ecc4',
                            'fill-opacity': {base: 1, stops: [[10, 0.3], [14, 0.5]]}
                        }
                    },
                    {
                        id: 'landuse',
                        type: 'fill',
                        source: 'openmaptiles',
                        'source-layer': 'landuse',
                        filter: ['==', 'class', 'agriculture'],
                        layout: {visibility: 'visible'},
                        paint: {'fill-color': '#eae0d0'}
                    },
                    {
                        id: 'waterway-tunnel',
                        type: 'line',
                        source: 'openmaptiles',
                        'source-layer': 'waterway',
                        filter: [
                            'all',
                            ['==', '$type', 'LineString'],
                            ['==', 'brunnel', 'tunnel']
                        ],
                        layout: {visibility: 'visible'},
                        paint: {
                            'line-color': 'hsl(205, 56%, 80%)',
                            'line-dasharray': [3, 3],
                            'line-gap-width': {stops: [[12, 0], [20, 6]]},
                            'line-opacity': 1,
                            'line-width': {base: 1.4, stops: [[8, 1], [20, 2]]}
                        }
                    },
                    {
                        id: 'waterway',
                        type: 'line',
                        source: 'openmaptiles',
                        'source-layer': 'waterway',
                        filter: [
                            'all',
                            ['==', '$type', 'LineString'],
                            ['!in', 'brunnel', 'tunnel', 'bridge'],
                            ['!=', 'intermittent', 1]
                        ],
                        layout: {visibility: 'visible'},
                        paint: {
                            'line-color': 'hsl(205, 56%, 80%)',
                            'line-opacity': 1,
                            'line-width': {base: 1.4, stops: [[8, 1], [20, 8]]}
                        }
                    },
                    {
                        id: 'waterway_intermittent',
                        type: 'line',
                        source: 'openmaptiles',
                        'source-layer': 'waterway',
                        filter: [
                            'all',
                            ['==', '$type', 'LineString'],
                            ['!in', 'brunnel', 'tunnel', 'bridge'],
                            ['==', 'intermittent', 1]
                        ],
                        layout: {visibility: 'visible'},
                        paint: {
                            'line-color': 'hsl(205, 56%, 80%)',
                            'line-dasharray': [2, 1],
                            'line-opacity': 1,
                            'line-width': {base: 1.4, stops: [[8, 1], [20, 8]]}
                        }
                    },
                    {
                        id: 'tunnel_railway_transit',
                        type: 'line',
                        source: 'openmaptiles',
                        'source-layer': 'transportation',
                        minzoom: 0,
                        filter: [
                            'all',
                            ['==', '$type', 'LineString'],
                            ['==', 'brunnel', 'tunnel'],
                            ['==', 'class', 'transit']
                        ],
                        layout: {'line-cap': 'butt', 'line-join': 'miter'},
                        paint: {
                            'line-color': 'hsl(34, 12%, 66%)',
                            'line-dasharray': [3, 3],
                            'line-opacity': {base: 1, stops: [[11, 0], [16, 1]]}
                        }
                    },
                    {
                        id: 'building',
                        type: 'fill',
                        source: 'openmaptiles',
                        'source-layer': 'building',
                        minzoom: 12,
                        paint: {
                            'fill-antialias': true,
                            'fill-color': 'rgba(222, 211, 190, 1)',
                            'fill-opacity': {base: 1, stops: [[12, 0], [14, 1]]},
                            'fill-outline-color': {
                                stops: [
                                    [13, 'rgba(212, 177, 146, 0)'],
                                    [14, 'rgba(212, 177, 146, 0.8)']
                                ]
                            }
                        }
                    },
                    {
                        id: 'track_path',
                        type: 'line',
                        source: 'openmaptiles',
                        'source-layer': 'transportation',
                        filter: [
                            'all',
                            ['==', '$type', 'LineString'],
                            ['in', 'class', 'track']
                        ],
                        minzoom: 11,
                        layout: {'line-cap': 'round', 'line-join': 'round'},
                        paint: {
                            'line-color': '#ffffff',
                            'line-dasharray': [3, 2],
                            'line-width': {base: 1.5, stops: [[10, 1], [13, 1.5], [20, 8]]}
                        }
                    },
                    {
                        id: 'road_path_paved',
                        type: 'line',
                        source: 'openmaptiles',
                        'source-layer': 'transportation',
                        filter: [
                            'all',
                            ['==', '$type', 'LineString'],
                            ['==', 'class', 'path'],
                            ['in', 'surface', 'paved', 'asphalt']
                        ],
                        minzoom: 11,
                        layout: {'line-cap': 'round', 'line-join': 'round'},
                        paint: {
                            'line-color': '#888888',
                            'line-width': 2
                        }
                    },
                    {
                        id: 'road_path_unpaved',
                        type: 'line',
                        source: 'openmaptiles',
                        'source-layer': 'transportation',
                        filter: [
                            'all',
                            ['==', '$type', 'LineString'],
                            ['==', 'class', 'path'],
                            [
                                'none',
                                ['==', 'surface', 'paved'],
                                ['==', 'surface', 'asphalt']
                            ]
                        ],
                        minzoom: 11,
                        layout: {'line-cap': 'round', 'line-join': 'round'},
                        paint: {
                            'line-color': '#ff5722',
                            'line-width': 2,
                            'line-dasharray': [2, 2]
                        }
                    },
                    {
                        id: 'road_minor',
                        type: 'line',
                        source: 'openmaptiles',
                        'source-layer': 'transportation',
                        filter: [
                            'all',
                            ['==', '$type', 'LineString'],
                            ['in', 'class', 'minor', 'service', 'residential']
                        ],
                        minzoom: 12,
                        layout: {'line-cap': 'round', 'line-join': 'round', visibility: 'visible'},
                        paint: {
                            'line-color': '#ffffff',
                            'line-width': {base: 1.55, stops: [[12, 2], [15, 3], [20, 10]]},
                            'line-opacity': 0.9
                        }
                    },
                    {
                        id: 'tunnel_minor',
                        type: 'line',
                        source: 'openmaptiles',
                        'source-layer': 'transportation',
                        filter: [
                            'all',
                            ['==', '$type', 'LineString'],
                            ['==', 'brunnel', 'tunnel'],
                            ['==', 'class', 'minor_road']
                        ],
                        layout: {'line-cap': 'butt', 'line-join': 'miter'},
                        paint: {
                            'line-color': '#efefef',
                            'line-dasharray': [0.36, 0.18],
                            'line-width': {base: 1.55, stops: [[4, 0.25], [20, 30]]}
                        }
                    },
                    {
                        id: 'tunnel_major',
                        type: 'line',
                        source: 'openmaptiles',
                        'source-layer': 'transportation',
                        filter: [
                            'all',
                            ['==', '$type', 'LineString'],
                            ['==', 'brunnel', 'tunnel'],
                            ['in', 'class', 'primary', 'secondary', 'tertiary', 'trunk']
                        ],
                        layout: {'line-cap': 'butt', 'line-join': 'miter'},
                        paint: {
                            'line-color': '#fff',
                            'line-dasharray': [0.28, 0.14],
                            'line-width': {base: 1.4, stops: [[6, 0.5], [20, 30]]}
                        }
                    },
                    {
                        id: 'road_trunk_primary',
                        type: 'line',
                        source: 'openmaptiles',
                        'source-layer': 'transportation',
                        filter: [
                            'all',
                            ['==', '$type', 'LineString'],
                            ['in', 'class', 'trunk', 'primary']
                        ],
                        layout: {'line-cap': 'round', 'line-join': 'round'},
                        paint: {
                            'line-color': '#ffa500',
                            'line-width': {base: 1.4, stops: [[6, 0.5], [20, 30]]}
                        }
                    },
                    {
                        id: 'road_secondary_tertiary',
                        type: 'line',
                        source: 'openmaptiles',
                        'source-layer': 'transportation',
                        filter: [
                            'all',
                            ['==', '$type', 'LineString'],
                            ['in', 'class', 'secondary', 'tertiary']
                        ],
                        layout: {'line-cap': 'round', 'line-join': 'round'},
                        paint: {
                            'line-color': '#ffcc00',
                            'line-width': {base: 1.4, stops: [[6, 0.5], [20, 20]]}
                        }
                    },
                    {
                        id: 'road_major_motorway',
                        type: 'line',
                        source: 'openmaptiles',
                        'source-layer': 'transportation',
                        filter: [
                            'all',
                            ['==', '$type', 'LineString'],
                            ['==', 'class', 'motorway']
                        ],
                        layout: {'line-cap': 'round', 'line-join': 'round'},
                        paint: {
                            'line-color': '#ff6600',
                            'line-offset': 0,
                            'line-width': {base: 1.4, stops: [[8, 1], [16, 10]]}
                        }
                    },
                    {
                        id: 'railway-transit',
                        type: 'line',
                        source: 'openmaptiles',
                        'source-layer': 'transportation',
                        filter: [
                            'all',
                            ['==', 'class', 'transit'],
                            ['!=', 'brunnel', 'tunnel']
                        ],
                        layout: {visibility: 'visible'},
                        paint: {
                            'line-color': 'hsl(34, 12%, 66%)',
                            'line-opacity': {base: 1, stops: [[11, 0], [16, 1]]}
                        }
                    },
                    {
                        id: 'railway',
                        type: 'line',
                        source: 'openmaptiles',
                        'source-layer': 'transportation',
                        filter: ['==', 'class', 'rail'],
                        layout: {visibility: 'visible'},
                        paint: {
                            'line-color': 'hsl(34, 12%, 66%)',
                            'line-opacity': {base: 1, stops: [[11, 0], [16, 1]]}
                        }
                    },
                    {
                        id: 'admin_sub',
                        type: 'line',
                        source: 'openmaptiles',
                        'source-layer': 'boundary',
                        minzoom: 3,
                        filter: ['in', 'admin_level', 4, 6, 8],
                        layout: {visibility: 'visible'},
                        paint: {'line-color': 'hsla(0, 0%, 60%, 0.5)', 'line-dasharray': [2, 1]}
                    },
                    {
                        id: 'admin_country',
                        type: 'line',
                        source: 'openmaptiles',
                        'source-layer': 'boundary',
                        minzoom: 0,
                        filter: [
                            'all',
                            ['<=', 'admin_level', 2],
                            ['==', '$type', 'LineString']
                        ],
                        layout: {
                            'line-cap': 'round',
                            'line-join': 'round',
                            visibility: 'visible'
                        },
                        paint: {
                            'line-color': 'hsl(0, 0%, 60%)',
                            'line-width': {base: 1.3, stops: [[3, 0.5], [22, 15]]}
                        }
                    },
                    {
                        id: 'mountain_peak',
                        type: 'symbol',
                        source: 'openmaptiles',
                        'source-layer': 'mountain_peak',
                        minzoom: 10,
                        filter: ['==', '$type', 'Point'],
                        layout: {
                            'icon-image': 'icon-peak',
                            'icon-size': {base: 1, stops: [[11, 0.5], [14, 0.7], [17, 1.0]]},
                            'icon-allow-overlap': true
                        }
                    },
                    {
                        id: 'mountain_peak_label',
                        type: 'symbol',
                        source: 'openmaptiles',
                        'source-layer': 'mountain_peak',
                        minzoom: 10,
                        filter: ['==', '$type', 'Point'],
                        layout: {
                            // ä½¿ç”¨ format è¡¨é”å¼ä¾†çµ„åˆé«˜åº¦èˆ‡åç¨±
                            'text-field': [
                                'format',
                                // ç¬¬ä¸€è¡Œï¼šé«˜åº¦ï¼ŒåŠ ä¸Š 'm' å–®ä½ï¼Œè¨­å®šå­—é«”ç¸®æ”¾ç‚º 0.8
                                ['concat', ['get', 'ele'], 'm'], { 'font-scale': 0.8 },
                                '\n', {}, // æ›è¡Œ
                                // ç¬¬äºŒè¡Œï¼šåç¨±ï¼ˆå„ªå…ˆå–ä¸­æ–‡ï¼Œæ²’æœ‰å‰‡å– nameï¼‰
                                ['coalesce', ['get', 'name:latin'], ['get', 'name']], { 'font-scale': 0.9 }
                            ],
                            'text-font': ['Noto Sans Bold'],
                            'text-size': {base: 1.4, stops: [[11, 10], [14, 12], [17, 16]]},
                            'text-anchor': 'top',
                            'text-offset': [0, 0.8],
                            'text-max-width': 10,
                            'text-optional': true
                        },
                        paint: {
                            'text-color': '#5D4037',
                            'text-halo-color': '#ffffff',
                            'text-halo-width': 2,
                            'text-halo-blur': 0.5
                        }
                    },
                    {
                        id: 'alpine_hut',
                        type: 'symbol',
                        source: 'openmaptiles',
                        'source-layer': 'poi',
                        minzoom: 11,
                        filter: [
                            'all',
                            ['==', 'class', 'lodging'],
                            ['in', 'subclass', 'alpine_hut', 'wilderness_hut', 'hut']
                        ],
                        layout: {
                            'icon-image': 'icon-hut',
                            'icon-size': {base: 1, stops: [[11, 0.5], [14, 0.7], [17, 1.0]]},
                            'icon-allow-overlap': true,
                            'icon-ignore-placement': true,
                            'icon-padding': 0,
                            'text-field': ['coalesce', ['get', 'name:latin'], ['get', 'name_int'], 'å±±å±‹'],
                            'text-font': ['Noto Sans Bold'],
                            'text-size': {base: 1.3, stops: [[11, 9], [14, 11], [17, 14]]},
                            'text-anchor': 'top',
                            'text-offset': [0, 0.8],
                            'text-max-width': 10,
                            'text-allow-overlap': false,
                            'text-ignore-placement': false,
                            'text-optional': true,
                            'symbol-placement': 'point',
                            'symbol-z-order': 'auto'
                        },
                        paint: {
                            'text-color': '#1E3A8A',
                            'text-halo-color': '#ffffff',
                            'text-halo-width': 2,
                            'text-halo-blur': 0.5
                        }
                    },
                    {
                        id: 'shelter',
                        type: 'symbol',
                        source: 'openmaptiles',
                        'source-layer': 'poi',
                        minzoom: 12,
                        filter: [
                            'all',
                            ['==', 'class', 'shelter']
                        ],
                        layout: {
                            'icon-image': 'icon-shelter',
                            'icon-size': {base: 1, stops: [[12, 0.5], [14, 0.7], [17, 1.0]]},
                            'icon-allow-overlap': true,
                            'icon-ignore-placement': true,
                            'icon-padding': 0,
                            'text-field': ['coalesce', ['get', 'name:latin'], ['get', 'name_int'], 'é¿é›£æ‰€'],
                            'text-font': ['Noto Sans Bold'],
                            'text-size': {base: 1.2, stops: [[12, 9], [14, 11], [17, 14]]},
                            'text-anchor': 'top',
                            'text-offset': [0, 0.7],
                            'text-max-width': 10,
                            'text-allow-overlap': false,
                            'text-ignore-placement': false,
                            'text-optional': true,
                            'symbol-placement': 'point',
                            'symbol-z-order': 'auto'
                        },
                        paint: {
                            'text-color': '#D97706',
                            'text-halo-color': '#ffffff',
                            'text-halo-width': 2,
                            'text-halo-blur': 0.5
                        }
                    },
                    {
                        id: 'camp_site',
                        type: 'symbol',
                        source: 'openmaptiles',
                        'source-layer': 'poi',
                        minzoom: 11,
                        filter: [
                            'all',
                            ['in', 'class', 'camp_site', 'campsite'], 
                            ['in', 'subclass', 'camp_site', 'caravan_site', 'campsite']
                        ],
                        layout: {
                            'icon-image': 'icon-campsite',
                            'icon-size': {base: 1, stops: [[11, 0.5], [14, 0.7], [17, 1.0]]},
                            'icon-allow-overlap': true,
                            'icon-ignore-placement': true,
                            'icon-padding': 0,
                            'text-field': ['coalesce', ['get', 'name:latin'], ['get', 'name_int'], 'ç‡Ÿåœ°'],
                            'text-font': ['Noto Sans Bold'],
                            'text-size': {base: 1.3, stops: [[11, 9], [14, 11], [17, 14]]},
                            'text-anchor': 'top',
                            'text-offset': [0, 0.8],
                            'text-max-width': 10,
                            'text-allow-overlap': false,
                            'text-ignore-placement': false,
                            'text-optional': true,
                            'symbol-placement': 'point',
                            'symbol-z-order': 'auto'
                        },
                        paint: {
                            'text-color': '#155724',
                            'text-halo-color': '#ffffff',
                            'text-halo-width': 2,
                            'text-halo-blur': 0.5
                        }
                    },
                    {
                        id: 'poi_label',
                        type: 'symbol',
                        source: 'openmaptiles',
                        'source-layer': 'poi',
                        minzoom: 14,
                        filter: ['all', ['==', '$type', 'Point'], ['==', 'rank', 1]],
                        layout: {
                            'icon-size': 1,
                            'text-anchor': 'top',
                            'text-field': '{name:latin}\n{name:nonlatin}',
                            'text-font': ['Noto Sans Regular'],
                            'text-max-width': 8,
                            'text-offset': [0, 0.5],
                            'text-size': 11,
                            visibility: 'visible'
                        },
                        paint: {
                            'text-color': '#666',
                            'text-halo-blur': 1,
                            'text-halo-color': 'rgba(255,255,255,0.75)',
                            'text-halo-width': 1
                        }
                    },
                    {
                        id: 'water-label',
                        type: 'symbol',
                        source: 'openmaptiles',
                        'source-layer': 'water_name',
                        minzoom: 4,
                        layout: {
                            'symbol-placement': 'line-center',
                            'text-anchor': 'top',
                            'text-field': '{name:latin}\n{name:nonlatin}',
                            'text-font': ['Noto Sans Regular'],
                            'text-max-width': 8,
                            'text-offset': [0, 0.5],
                            'text-size': 14,
                            visibility: 'visible',
                            'symbol-avoid-edges': true
                        },
                        paint: {
                            'text-color': '#666',
                            'text-halo-blur': 1,
                            'text-halo-color': 'rgba(255,255,255,1)',
                            'text-halo-width': 1
                        }
                    },
                    {
                        id: 'road_major_label',
                        type: 'symbol',
                        source: 'openmaptiles',
                        'source-layer': 'transportation_name',
                        minzoom: 12,
                        filter: [
                            'all',
                            ['==', '$type', 'LineString'],
                            ['!in', 'class', 'path', 'track']
                        ],
                        layout: {
                            'symbol-placement': 'line',
                            'text-field': '{name:latin} {name:nonlatin}',
                            'text-font': ['Noto Sans Regular'],
                            'text-letter-spacing': 0.1,
                            'text-rotation-alignment': 'map',
                            'text-size': {base: 1.4, stops: [[10, 8], [20, 14]]},
                            'text-transform': 'uppercase',
                            visibility: 'visible'
                        },
                        paint: {
                            'text-color': '#000',
                            'text-halo-color': 'hsl(0, 0%, 100%)',
                            'text-halo-width': 2
                        }
                    },
                    {
                        id: 'trail_label',
                        type: 'symbol',
                        source: 'openmaptiles',
                        'source-layer': 'transportation_name',
                        minzoom: 10,
                        filter: [
                            'all',
                            ['==', '$type', 'LineString'],
                            ['in', 'class', 'path', 'track']
                        ],
                        layout: {
                            'symbol-placement': 'line',
                            'text-field': '{name:latin} {name:nonlatin}',
                            'text-font': ['Noto Sans Bold'],
                            'text-letter-spacing': 0.05,
                            'text-rotation-alignment': 'map',
                            'text-size': {base: 1.5, stops: [[10, 9], [13, 11], [20, 16]]},
                            'symbol-spacing': 350,
                            visibility: 'visible'
                        },
                        paint: {
                            'text-color': '#8B4513',
                            'text-halo-color': '#ffffff',
                            'text-halo-width': 2.5,
                            'text-halo-blur': 0.5
                        }
                    },
                    {
                        id: 'place_label_other',
                        type: 'symbol',
                        source: 'openmaptiles',
                        'source-layer': 'place',
                        minzoom: 8,
                        filter: [
                            'all',
                            ['==', '$type', 'Point'],
                            ['!in', 'class', 'city', 'state', 'country', 'continent']
                        ],
                        layout: {
                            'text-anchor': 'center',
                            'text-field': '{name:latin}\n{name:nonlatin}',
                            'text-font': ['Noto Sans Regular'],
                            'text-max-width': 6,
                            'text-size': {stops: [[6, 10], [12, 14]]},
                            visibility: 'visible'
                        },
                        paint: {
                            'text-color': 'hsl(0, 0%, 25%)',
                            'text-halo-blur': 0,
                            'text-halo-color': 'hsl(0, 0%, 100%)',
                            'text-halo-width': 2
                        }
                    },
                    {
                        id: 'place_label_city',
                        type: 'symbol',
                        source: 'openmaptiles',
                        'source-layer': 'place',
                        maxzoom: 16,
                        filter: ['all', ['==', '$type', 'Point'], ['==', 'class', 'city']],
                        layout: {
                            'text-field': '{name:latin}\n{name:nonlatin}',
                            'text-font': ['Noto Sans Regular'],
                            'text-max-width': 10,
                            'text-size': {stops: [[3, 12], [8, 16]]}
                        },
                        paint: {
                            'text-color': 'hsl(0, 0%, 0%)',
                            'text-halo-blur': 0,
                            'text-halo-color': 'hsla(0, 0%, 100%, 0.75)',
                            'text-halo-width': 2
                        }
                    },
                    {
                        id: 'country_label',
                        type: 'symbol',
                        source: 'openmaptiles',
                        'source-layer': 'place',
                        maxzoom: 12,
                        filter: [
                            'all',
                            ['==', '$type', 'Point'],
                            ['==', 'class', 'country'],
                            ['has', 'iso_a2']
                        ],
                        layout: {
                            'text-field': '{name:latin}',
                            'text-font': ['Noto Sans Bold'],
                            'text-max-width': 10,
                            'text-size': {stops: [[3, 12], [8, 22]]},
                            visibility: 'visible'
                        },
                        paint: {
                            'text-color': 'hsl(0, 0%, 13%)',
                            'text-halo-blur': 0,
                            'text-halo-color': 'rgba(255,255,255,0.75)',
                            'text-halo-width': 2
                        }
                    }
                ]
            },
            center: [120.8, 23.665520],
            zoom: 8,
            minZoom: 7,
            maxBounds: [[116.0, 20.5], [124.5, 26.5]],
        });

        map.addControl(new maplibregl.NavigationControl());
        map.addControl(new maplibregl.ScaleControl());
        const geolocateControl = new maplibregl.GeolocateControl({
            positionOptions: { enableHighAccuracy: true },
            trackUserLocation: true,
            showUserLocation: true,
            showAccuracyCircle: true
        });
        map.addControl(geolocateControl, 'top-right');

        const locationInfoPanel = document.createElement('div');
        locationInfoPanel.id = 'location-info-panel';
        locationInfoPanel.className = 'location-info-panel';
        locationInfoPanel.innerHTML = '<div class="loc-hint">é»æ“Šå®šä½æŒ‰éˆ•ï¼Œé¡¯ç¤ºåº§æ¨™èˆ‡é«˜åº¦</div>';
        document.getElementById('map').appendChild(locationInfoPanel);

        // å„²å­˜æœ€å¾Œä¸€æ¬¡å®šä½ï¼ˆä¾›é™„è¿‘æ­¥é“åŠŸèƒ½ä½¿ç”¨ï¼‰
        let lastKnownPosition = null;
        
        geolocateControl.on('geolocate', (e) => {
            const pos = e.coords;
            if (!pos) return;
            const { latitude, longitude, altitude } = pos;
            
            // å„²å­˜æœ€å¾Œå®šä½èˆ‡æ™‚é–“æˆ³è¨˜
            lastKnownPosition = {
                lat: latitude,
                lon: longitude,
                timestamp: Date.now()
            };
            
            locationInfoPanel.innerHTML = `
                <div class="loc-row">ç¶“åº¦ï¼š${longitude.toFixed(6)}Â°</div>
                <div class="loc-row">ç·¯åº¦ï¼š${latitude.toFixed(6)}Â°</div>
                <div class="loc-row">é«˜åº¦ï¼š${altitude != null ? Math.round(altitude) + ' m' : 'â€”'}</div>
            `;
        });
        geolocateControl.on('error', () => {
            locationInfoPanel.innerHTML = '<div class="loc-hint">é»æ“Šå®šä½æŒ‰éˆ•ï¼Œé¡¯ç¤ºåº§æ¨™èˆ‡é«˜åº¦</div>';
        });

        // é¦–é ï¼ˆç„¡ trail åƒæ•¸ï¼‰æ™‚ï¼Œè‡ªå‹•å®šä½ä¸€æ¬¡
        const urlParams = new URLSearchParams(window.location.search);
        const hasTrailParam = urlParams.has('trail_id') || urlParams.has('temp_trail') || urlParams.has('pending_trail');
        if (!hasTrailParam) {
            let autoLocateTriggered = false;
            const autoLocate = () => {
                if (autoLocateTriggered) return;
                autoLocateTriggered = true;
                geolocateControl.trigger();
            };
            if (map.loaded()) {
                autoLocate();
            } else {
                map.once('load', autoLocate);
            }
        }

        // æ¸¬é‡åŠŸèƒ½
        let measureModeActive = false;
        let measurePoints = [];
        let measureMarkers = [];
        let measureLineSourceId = null;
        let measureLineLayerId = null;
        let measureClickHandler = null;

        class MeasureControl {
            onAdd(map) {
                this._map = map;
                this._container = document.createElement('div');
                this._container.className = 'maplibregl-ctrl maplibregl-ctrl-group maplibregl-ctrl-measure';
                this._btn = document.createElement('button');
                this._btn.className = 'maplibregl-ctrl-icon';
                this._btn.type = 'button';
                this._btn.title = 'æ¸¬é‡è·é›¢';
                this._btn.innerHTML = 'ğŸ“';
                this._btn.setAttribute('aria-label', 'æ¸¬é‡è·é›¢');
                this._container.appendChild(this._btn);
                this._btn.addEventListener('click', () => this._toggleMeasure());
                return this._container;
            }
            onRemove() {
                this._btn.removeEventListener('click', () => this._toggleMeasure());
                this._container.parentNode.removeChild(this._container);
                this._map = undefined;
            }
            _toggleMeasure() {
                if (measureModeActive) {
                    closeMeasurePanel();
                } else {
                    openMeasurePanel();
                }
            }
        }

        const measurePanel = document.createElement('div');
        measurePanel.id = 'measure-info-panel';
        measurePanel.className = 'measure-info-panel';
        measurePanel.innerHTML = `
            <div class="measure-header">
                <span class="measure-title">ğŸ“ æ¸¬é‡è·é›¢</span>
                <button class="measure-close" onclick="closeMeasurePanel()" title="é—œé–‰">Ã—</button>
            </div>
            <div class="measure-hint">é»æ“Šåœ°åœ–è¨­ç«‹åœ–æ¨™ï¼Œæœƒè‡ªå‹•è¨ˆç®—æ‰€æœ‰åº§æ¨™é»åŠ èµ·ä¾†çš„è·é›¢</div>
            <div class="measure-points" id="measure-points-list"></div>
            <div class="measure-total" id="measure-total">ç¸½è·é›¢ï¼š0 km</div>
        `;
        document.getElementById('map').appendChild(measurePanel);

        function openMeasurePanel() {
            const trailPanel = document.getElementById('trail-info-panel');
            if (trailPanel && trailPanel.classList.contains('show')) {
                minimizeTrailPanel({ stopPropagation: () => {} });
            }
            measureModeActive = true;
            document.querySelector('.maplibregl-ctrl-measure button').classList.add('active');
            measurePanel.classList.add('show');
            updateMeasurePointsList();
            measureClickHandler = (e) => {
                const { lng, lat } = e.lngLat;
                measurePoints.push({ lat, lon: lng });
                addMeasureMarker(measurePoints.length, lat, lng);
                updateMeasureLine();
                updateMeasurePointsList();
            };
            map.on('click', measureClickHandler);
            map.getCanvas().style.cursor = 'crosshair';
        }

        function closeMeasurePanel() {
            measureModeActive = false;
            const btn = document.querySelector('.maplibregl-ctrl-measure button');
            if (btn) btn.classList.remove('active');
            measurePanel.classList.remove('show');
            if (measureClickHandler) {
                map.off('click', measureClickHandler);
                measureClickHandler = null;
            }
            map.getCanvas().style.cursor = '';
            measurePoints = [];
            measureMarkers.forEach(m => m.remove());
            measureMarkers = [];
            if (measureLineSourceId && map.getSource(measureLineSourceId)) {
                map.removeLayer(measureLineLayerId);
                map.removeSource(measureLineSourceId);
                measureLineSourceId = null;
                measureLineLayerId = null;
            }
        }

        function addMeasureMarker(num, lat, lon) {
            const el = document.createElement('div');
            el.className = 'measure-marker';
            el.style.cssText = `
                width: 24px; height: 24px;
                background: #667eea; color: white;
                border: 2px solid white;
                border-radius: 50%;
                display: flex; align-items: center; justify-content: center;
                font-size: 12px; font-weight: bold;
            `;
            el.textContent = num;
            const marker = new maplibregl.Marker({ element: el })
                .setLngLat([lon, lat])
                .addTo(map);
            measureMarkers.push(marker);
        }

        function updateMeasureLine() {
            if (measurePoints.length < 2) return;
            try {
                const lineId = 'measure-line';
                if (map.getSource(lineId)) {
                map.getSource(lineId).setData({
                    type: 'Feature',
                    properties: {},
                    geometry: {
                        type: 'LineString',
                        coordinates: measurePoints.map(p => [p.lon, p.lat])
                    }
                });
            } else {
                map.addSource(lineId, {
                    type: 'geojson',
                    data: {
                        type: 'Feature',
                        properties: {},
                        geometry: {
                            type: 'LineString',
                            coordinates: measurePoints.map(p => [p.lon, p.lat])
                        }
                    }
                });
                map.addLayer({
                    id: lineId + '-layer',
                    type: 'line',
                    source: lineId,
                    paint: {
                        'line-color': '#667eea',
                        'line-width': 3,
                        'line-dasharray': [2, 1]
                    }
                });
                measureLineSourceId = lineId;
                measureLineLayerId = lineId + '-layer';
            }
            } catch (e) {
                console.warn('Measure line update failed:', e);
            }
        }

        function updateMeasurePointsList() {
            const listEl = document.getElementById('measure-points-list');
            const totalEl = document.getElementById('measure-total');
            if (!listEl || !totalEl) return;
            let html = '';
            let totalDist = 0;
            for (let i = 0; i < measurePoints.length; i++) {
                const p = measurePoints[i];
                let segDist = '';
                if (i > 0) {
                    const d = calculateDistance(measurePoints[i-1].lat, measurePoints[i-1].lon, p.lat, p.lon);
                    totalDist += d;
                    segDist = ` <span style="color:#999">(+${d.toFixed(2)} km)</span>`;
                }
                html += `<div>${i + 1}. ${p.lat.toFixed(5)}Â°, ${p.lon.toFixed(5)}Â°${segDist}</div>`;
            }
            listEl.innerHTML = html || '<span style="color:#999">å°šæœªè¨­ç«‹åœ–æ¨™</span>';
            totalEl.textContent = `ç¸½è·é›¢ï¼š${totalDist.toFixed(2)} km`;
        }

        window.closeMeasurePanel = closeMeasurePanel;

        map.addControl(new MeasureControl(), 'top-right');

        // ============================================
        // ç­‰é«˜ç·šåŠŸèƒ½
        // ============================================
        let contourLinesVisible = false;
        let contourLayersAdded = false;

        class ContourControl {
            onAdd(map) {
                this._map = map;
                this._container = document.createElement('div');
                this._container.className = 'maplibregl-ctrl maplibregl-ctrl-group maplibregl-ctrl-contour';
                this._btn = document.createElement('button');
                this._btn.className = 'maplibregl-ctrl-icon';
                this._btn.type = 'button';
                this._btn.title = 'é¡¯ç¤ºç­‰é«˜ç·š';
                this._btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2" width="20" height="20"><ellipse cx="12" cy="12" rx="10" ry="8"></ellipse><ellipse cx="12" cy="12" rx="7" ry="5"></ellipse><ellipse cx="12" cy="12" rx="4" ry="2"></ellipse></svg>';
                this._btn.setAttribute('aria-label', 'é¡¯ç¤ºç­‰é«˜ç·š');
                this._container.appendChild(this._btn);
                this._btn.addEventListener('click', () => this._toggleContour());
                return this._container;
            }
            onRemove() {
                this._btn.removeEventListener('click', () => this._toggleContour());
                this._container.parentNode.removeChild(this._container);
                this._map = undefined;
            }
            _toggleContour() {
                toggleContourLines();
            }
        }

        function initializeContourLayers() {
            if (contourLayersAdded) return;
            
            try {
                // å‹•æ…‹æ§‹å»ºç­‰é«˜ç·šç“¦ç‰‡ URLï¼ˆä½¿ç”¨æœ¬åœ° MBTiles æ–‡ä»¶ï¼‰
                let contourTilesUrl;
                const hostname = window.location.hostname;
                
                // æœ¬åœ°é–‹ç™¼ç’°å¢ƒï¼šç›´æ¥ä½¿ç”¨ tileserver ç«¯å£
                if (hostname === 'localhost' || hostname === '127.0.0.1') {
                    contourTilesUrl = 'http://localhost:8080/data/taiwan-contours/{z}/{x}/{y}.pbf';
                } else {
                    // ç”Ÿç”¢ç’°å¢ƒï¼šä½¿ç”¨ nginx ä»£ç†
                    contourTilesUrl = window.location.origin + '/tiles/data/taiwan-contours/{z}/{x}/{y}.pbf';
                }
                
                // æ·»åŠ ç­‰é«˜ç·šè³‡æ–™æºï¼ˆå¾ MBTiles åŠ è¼‰é å…ˆè¨ˆç®—çš„ 20m ç­‰é«˜ç·šï¼‰
                map.addSource('contour-source', {
                    type: 'vector',
                    tiles: [contourTilesUrl],
                    minzoom: 0,
                    maxzoom: 12
                });
                
                // æ·»åŠ ç­‰é«˜ç·šåœ–å±¤ï¼ˆ20m é–“è·ï¼Œä¾æ“š type å€åˆ†ç²—ç´°ï¼‰
                map.addLayer({
                    id: 'contour-lines',
                    type: 'line',
                    source: 'contour-source',
                    'source-layer': 'contours',
                    layout: {
                        visibility: 'none',
                        'line-join': 'round',
                        'line-cap': 'round'
                    },
                    paint: {
                        'line-color': '#8B7355',
                        'line-opacity': [
                            'match',
                            ['get', 'type'],
                            'major', 0.7,
                            'minor', 0.5,
                            0.5
                        ],
                        'line-width': [
                            'interpolate',
                            ['linear'],
                            ['zoom'],
                            8, [
                                'match',
                                ['get', 'type'],
                                'major', 0.6,
                                'minor', 0.3,
                                0.3
                            ],
                            12, [
                                'match',
                                ['get', 'type'],
                                'major', 1.2,
                                'minor', 0.6,
                                0.6
                            ]
                        ]
                    }
                });
                
                // æ·»åŠ ç­‰é«˜ç·šæ¨™ç±¤ï¼ˆåªåœ¨ä¸»è¦ç·šä¸Šé¡¯ç¤ºï¼‰
                map.addLayer({
                    id: 'contour-labels',
                    type: 'symbol',
                    source: 'contour-source',
                    'source-layer': 'contours',
                    filter: ['==', ['get', 'type'], 'major'],
                    layout: {
                        visibility: 'none',
                        'symbol-placement': 'line',
                        'text-size': [
                            'interpolate',
                            ['linear'],
                            ['zoom'],
                            8, 8,
                            12, 11
                        ],
                        'text-field': ['concat', ['to-string', ['get', 'elevation']], 'm'],
                        'text-font': ['Noto Sans Regular'],
                        'text-rotation-alignment': 'map',
                        'text-pitch-alignment': 'viewport',
                        'symbol-spacing': 400,
                        'text-max-angle': 30
                    },
                    paint: {
                        'text-color': '#654321',
                        'text-halo-color': 'rgba(255, 255, 255, 0.9)',
                        'text-halo-width': 2
                    }
                });
                
                contourLayersAdded = true;
                console.log('ç­‰é«˜ç·šåœ–å±¤å·²åˆå§‹åŒ–ï¼ˆ20m é–“è·ï¼Œä¾†è‡ª taiwan_contours.mbtilesï¼‰');
            } catch (error) {
                console.error('åˆå§‹åŒ–ç­‰é«˜ç·šåœ–å±¤å¤±æ•—:', error);
                alert('è¼‰å…¥ç­‰é«˜ç·šåŠŸèƒ½å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢å†è©¦');
            }
        }

        function toggleContourLines() {
            // ç¬¬ä¸€æ¬¡ä½¿ç”¨æ™‚åˆå§‹åŒ–åœ–å±¤
            if (!contourLayersAdded) {
                initializeContourLayers();
            }
            
            contourLinesVisible = !contourLinesVisible;
            const visibility = contourLinesVisible ? 'visible' : 'none';
            
            // åˆ‡æ›åœ–å±¤å¯è¦‹æ€§
            if (map.getLayer('contour-lines')) {
                map.setLayoutProperty('contour-lines', 'visibility', visibility);
            }
            if (map.getLayer('contour-labels')) {
                map.setLayoutProperty('contour-labels', 'visibility', visibility);
            }
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            const btn = document.querySelector('.maplibregl-ctrl-contour button');
            if (btn) {
            if (contourLinesVisible) {
                btn.classList.add('active');
                btn.title = 'éš±è—ç­‰é«˜ç·š';
                btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2" width="20" height="20"><ellipse cx="12" cy="12" rx="10" ry="8"></ellipse><ellipse cx="12" cy="12" rx="7" ry="5"></ellipse><ellipse cx="12" cy="12" rx="4" ry="2"></ellipse></svg>';
            } else {
                btn.classList.remove('active');
                btn.title = 'é¡¯ç¤ºç­‰é«˜ç·š';
                btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2" width="20" height="20"><ellipse cx="12" cy="12" rx="10" ry="8"></ellipse><ellipse cx="12" cy="12" rx="7" ry="5"></ellipse><ellipse cx="12" cy="12" rx="4" ry="2"></ellipse></svg>';
            }
            }
        }

        window.toggleContourLines = toggleContourLines;

        map.addControl(new ContourControl(), 'top-right');

        function updateMapPadding() {
            if (window.innerWidth <= 1279) {
                map.setPadding({ top: 140, bottom: 0, left: 0, right: 0 });
            } else {
                map.setPadding({ top: 50, bottom: 50, left: 50, right: 50 });
            }
        }

        updateMapPadding();
        window.addEventListener('resize', updateMapPadding);

        map.on('load', () => {
            console.log('OpenTrailMap å·²è¼‰å…¥');
            const icons = {
                'icon-peak': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="#ffffff" d="M0 0h24v24H0z"/><path fill="#8B4513" d="M14 6l-3.75 5 2.85 3.8-1.6 1.2C9.81 13.75 7 10 7 10l-6 8h22L14 6z"/></svg>`,
                'icon-hut': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="#ffffff" d="M0 0h24v24H0z"/><path fill="#1E3A8A" d="M12 3L2 12h3v8h14v-8h3L12 3zm0 13.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>`,
                'icon-campsite': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="#ffffff" d="M0 0h24v24H0z"/><path fill="#155724" d="M4 18l8-14 8 14H4zm8-11.5L7.5 16h9L12 6.5z"/></svg>`,
                'icon-shelter': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="#ffffff" d="M0 0h24v24H0z"/><path fill="#D97706" d="M12 3L2 12h20L12 3zm0 3.84L17.16 10H6.84L12 6.84zM4 14h16v2H4v-2zm0 4h16v2H4v-2z"/></svg>`
            };

            Object.entries(icons).forEach(([id, svg]) => {
                const img = new Image();
                img.onload = () => map.addImage(id, img);
                img.src = 'data:image/svg+xml;base64,' + btoa(svg);
            });
        });

        map.on('zoom', () => {
            // ç¢ºä¿ zoom ä¸å°æ–¼ 7
            if (map.getZoom() < 7) {
                map.setZoom(7);
                return;
            }
        });

        // ç›£è½ zoomend äº‹ä»¶ï¼Œç¢ºä¿ä¸æœƒç¸®å°åˆ°å°æ–¼ 7
        map.on('zoomend', () => {
            if (map.getZoom() < 7) {
                map.setZoom(7);
            }
        });

        map.on('error', (e) => {
            console.error('åœ°åœ–éŒ¯èª¤:', e);
        });

        // é˜²æŠ–å‡½æ•¸
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // æ¡Œé¢ç«¯æœç´¢
        window.searchPeaks = function() {
            const input = document.getElementById('peak-search-input');
            const query = input.value.trim();
            const resultsDiv = document.getElementById('search-results');
            
            if (!query) {
                resultsDiv.style.display = 'none';
                return;
            }
            
            performSearch(query, resultsDiv);
        };

        // ç§»åŠ¨ç«¯æœç´¢
        window.searchPeaksMobile = function() {
            const input = document.getElementById('mobile-peak-search-input');
            const query = input.value.trim();
            const resultsDiv = document.getElementById('mobile-search-results');
            
            if (!query) {
                resultsDiv.style.display = 'none';
                return;
            }
            
            performSearch(query, resultsDiv);
        };

        // ç»Ÿä¸€æœç´¢å‡½æ•° - ä½¿ç”¨ Django API
        function performSearch(query, resultsDiv) {
            fetch(`/api/search/?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    displaySearchResults(data, resultsDiv);
                })
                .catch(error => {
                    console.error('æœç´¢å¤±è´¥:', error);
                    resultsDiv.innerHTML = '<div class="search-no-results">æœç´¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
                    resultsDiv.style.display = 'block';
                });
        }

        function displaySearchResults(data, resultsDiv) {
            if (data.count === 0) {
                resultsDiv.innerHTML = '<div class="search-no-results">æœªæ‰¾åˆ°åŒ¹é…çµæœ</div>';
                resultsDiv.style.display = 'block';
                return;
            }
            
            let html = '';
            data.results.forEach((result, index) => {
                const itemId = `result-item-${Date.now()}-${index}`;
                const isTrail = result.type === 'trail';
                const dataAttrs = isTrail 
                    ? `data-type="trail" data-trail-id="${result.trail_id}"` 
                    : `data-type="point" data-lon="${result.lon}" data-lat="${result.lat}"`;
                
                html += `
                    <button type="button" class="search-result-item" ${dataAttrs} data-name="${result.display.replace(/"/g, '&quot;')}" id="${itemId}">
                        <div class="search-result-name">${result.display}</div>
                        <div class="search-result-info">${isTrail ? 'æ­¥é“' : `åº§æ¨™: ${result.lat.toFixed(4)}, ${result.lon.toFixed(4)}`}</div>
                    </button>
                `;
            });
            
            resultsDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
            
            // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼ˆç§»åŠ¨ç«¯ä¼˜å…ˆä½¿ç”¨ touchendï¼‰
            const resultItems = resultsDiv.querySelectorAll('.search-result-item');
            resultItems.forEach(item => {
                const handleAction = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const type = this.getAttribute('data-type');
                    const name = this.getAttribute('data-name');
                    
                    if (type === 'trail') {
                        // æ­¥é“é¡å‹ï¼šè¼‰å…¥ä¸¦é¡¯ç¤ºæ­¥é“
                        const trailId = this.getAttribute('data-trail-id');
                        loadAndDisplayTrail(trailId, name);
                    } else {
                        // é»é¡å‹ï¼šç›´æ¥å®šä½
                        const lon = parseFloat(this.getAttribute('data-lon'));
                        const lat = parseFloat(this.getAttribute('data-lat'));
                        flyToLocation(lon, lat, name);
                    }
                    
                    // å»¶è¿Ÿæ”¶èµ·é”®ç›˜ï¼Œé¿å…å¹²æ‰°åœ°å›¾ç§»åŠ¨
                    setTimeout(() => {
                        const mobileInput = document.getElementById('mobile-peak-search-input');
                        const desktopInput = document.getElementById('peak-search-input');
                        if (mobileInput) mobileInput.blur();
                        if (desktopInput) desktopInput.blur();
                    }, 1500);
                };
                
                // åŒæ—¶ç»‘å®š touchend å’Œ click äº‹ä»¶
                // touchend åœ¨ç§»åŠ¨ç«¯ä¼šä¼˜å…ˆè§¦å‘ï¼Œclick ä½œä¸ºæ¡Œé¢ç«¯åå¤‡
                let touchHandled = false;
                
                item.addEventListener('touchend', function(e) {
                    touchHandled = true;
                    handleAction.call(this, e);
                    // é˜²æ­¢ click äº‹ä»¶ä¹Ÿè¢«è§¦å‘
                    setTimeout(() => { touchHandled = false; }, 500);
                });
                
                item.addEventListener('click', function(e) {
                    if (!touchHandled) {
                        handleAction.call(this, e);
                    }
                });
            });
        }

        window.flyToLocation = function(lon, lat, name) {
            if (typeof lon !== 'number' || typeof lat !== 'number' || isNaN(lon) || isNaN(lat)) {
                console.error('Invalid coordinates:', lon, lat);
                return;
            }
            
            map.flyTo({
                center: [lon, lat],
                zoom: 14,
                duration: 1500
            });
            
            // éšè—æœç´¢ç»“æœ
            const mobileResults = document.getElementById('mobile-search-results');
            if (mobileResults) {
                mobileResults.style.display = 'none';
            }
            const desktopResults = document.getElementById('search-results');
            if (desktopResults) {
                desktopResults.style.display = 'none';
            }
        };

        // è¼‰å…¥ä¸¦é¡¯ç¤ºæ­¥é“
        let currentTrailLayerId = null;
        let currentTrailSourceId = null;
        let currentTrailData = null;
        let currentTrailId = null;
        let currentTrailName = null;
        let currentIsTemporary = false;
        let currentTrailBounds = null;  // å­˜å„²è·¯ç·šçš„é‚Šç•Œæˆ–ä¸­å¿ƒï¼Œç”¨æ–¼ã€Œå®šä½å›è·¯ç·šã€åŠŸèƒ½

        window.loadAndDisplayTrail = function(trailId, trailName, updateUrl = true) {
            // å…ˆæ¸…é™¤ä¹‹å‰çš„æ­¥é“åœ–å±¤
            clearTrailLayer();
            
            // å¾ API è¼‰å…¥æ­¥é“è³‡æ–™
            fetch(`/api/trail/${trailId}/`)
                .then(response => response.json())
                .then(data => {
                    if (!data.success || !data.trail || !data.trail.path_data) {
                        console.error('ç„¡æ³•è¼‰å…¥æ­¥é“è³‡æ–™');
                        alert('æ­¤æ­¥é“æš«ç„¡è·¯å¾‘è³‡æ–™');
                        return;
                    }
                    
                    const trail = data.trail;
                    currentTrailData = trail;
                    currentTrailId = trailId;
                    currentTrailName = trail.trail_name;
                    
                    displayTrailOnMap(trail);
                    
                    // è¨ˆç®—ä¸¦é¡¯ç¤ºæ­¥é“çµ±è¨ˆè³‡è¨Š
                    displayTrailInfo(trail);
                    
                    // é¡¯ç¤ºåˆ†äº«æŒ‰éˆ•
                    const shareBtn = document.getElementById('share-trail-btn');
                    if (shareBtn) {
                        shareBtn.style.display = 'inline-flex';
                    }
                    
                    // é¡¯ç¤ºå®šä½å›è·¯ç·šæŒ‰éˆ•
                    const centerBtn = document.getElementById('trail-center-btn');
                    if (centerBtn) {
                        centerBtn.style.display = 'inline-flex';
                    }
                    
                    // æ›´æ–° URLï¼ˆä½¿ç”¨æ­¥é“ IDï¼ŒHistory APIï¼Œä¸åˆ·æ–°é é¢ï¼‰
                    if (updateUrl) {
                        const newUrl = `${window.location.pathname}?trail_id=${trailId}`;
                        window.history.pushState({trailId: trailId, trailName: trail.trail_name}, '', newUrl);
                    }
                    
                    // ä½¿ç”¨é‚Šç•Œæ¡†è‡ªå‹•ç¸®æ”¾åˆ°é©åˆçš„å¤§å°ï¼Œä¸¦å­˜å„²é‚Šç•Œè³‡è¨Š
                    if (trail.bounds && trail.bounds.min_lat && trail.bounds.max_lat) {
                        const bounds = [
                            [trail.bounds.min_lon, trail.bounds.min_lat], // è¥¿å—è§’
                            [trail.bounds.max_lon, trail.bounds.max_lat]  // æ±åŒ—è§’
                        ];
                        currentTrailBounds = { bounds: bounds, type: 'bounds' };
                        
                        map.fitBounds(bounds, {
                            padding: {top: 50, bottom: 250, left: 50, right: 50},  // åº•éƒ¨å¢åŠ  padding è®“æ­¥é“ä¸Šç§»
                            duration: 1500,
                            maxZoom: 14  // é¿å…æ”¾å¾—å¤ªå¤§
                        });
                    } else if (trail.center_lat && trail.center_lon) {
                        // å‚™ç”¨æ–¹æ¡ˆï¼šå¦‚æœæ²’æœ‰é‚Šç•Œæ¡†ï¼Œä½¿ç”¨ä¸­å¿ƒé»
                        currentTrailBounds = { 
                            center: [trail.center_lon, trail.center_lat], 
                            zoom: 13,
                            type: 'center' 
                        };
                        map.flyTo({
                            center: [trail.center_lon, trail.center_lat],
                            zoom: 13,
                            duration: 1500
                        });
                    }
                    
                    // éšè—æœç´¢ç»“æœ
                    const mobileResults = document.getElementById('mobile-search-results');
                    if (mobileResults) {
                        mobileResults.style.display = 'none';
                    }
                    const desktopResults = document.getElementById('search-results');
                    if (desktopResults) {
                        desktopResults.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('è¼‰å…¥æ­¥é“å¤±æ•—:', error);
                    alert('è¼‰å…¥æ­¥é“å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                });
        };

        function displayTrailOnMap(trail) {
            if (!trail.path_segments || trail.path_segments.length === 0) {
                console.log('æ­¥é“æ²’æœ‰æœ‰æ•ˆçš„è·¯å¾‘è³‡æ–™');
                return;
            }
            
            console.log(`æ­¥é“ "${trail.trail_name}" å…±æœ‰ ${trail.segment_count} å€‹é€£çºŒè·¯æ®µ`);
            
            // ç”¢ç”Ÿå”¯ä¸€çš„ source å’Œ layer ID
            const sourceId = `trail-source-${trail.trail_id}`;
            const layerId = `trail-layer-${trail.trail_id}`;
            
            currentTrailSourceId = sourceId;
            currentTrailLayerId = layerId;
            
            // å°‡æ‰€æœ‰è·¯æ®µè½‰æ›ç‚º GeoJSON MultiLineString æ ¼å¼
            const allCoordinates = trail.path_segments.map(segment => 
                segment.map(point => [point.lon, point.lat])
            );
            
            const geojson = {
                type: 'Feature',
                geometry: {
                    type: 'MultiLineString',  // ä½¿ç”¨ MultiLineString æ”¯æ´å¤šå€‹ä¸é€£çºŒçš„ç·šæ®µ
                    coordinates: allCoordinates
                },
                properties: {
                    trail_id: trail.trail_id,
                    trail_name: trail.trail_name,
                    segment_count: trail.segment_count
                }
            };
            
            // æ–°å¢ source
            map.addSource(sourceId, {
                type: 'geojson',
                data: geojson
            });
            
            // æ–°å¢åœ–å±¤ï¼ˆé«˜äº®é¡¯ç¤º - ç´«è‰²ï¼‰
            map.addLayer({
                id: layerId,
                type: 'line',
                source: sourceId,
                layout: {
                    'line-join': 'round',
                    'line-cap': 'round'
                },
                paint: {
                    'line-color': '#9333EA',  // ç´«è‰²é«˜äº®
                    'line-width': 4,
                    'line-opacity': 0.85
                }
            });
            
            // æ–°å¢å¤–æ¡†åœ–å±¤ï¼ˆæ›´æ˜é¡¯ï¼‰
            map.addLayer({
                id: `${layerId}-outline`,
                type: 'line',
                source: sourceId,
                layout: {
                    'line-join': 'round',
                    'line-cap': 'round'
                },
                paint: {
                    'line-color': '#FFFFFF',
                    'line-width': 6,
                    'line-opacity': 0.6
                }
            }, layerId);  // æ’å…¥åœ¨ä¸»åœ–å±¤ä¸‹æ–¹
            
            console.log(`æ­¥é“ "${trail.trail_name}" å·²é¡¯ç¤ºåœ¨åœ°åœ–ä¸Š (${trail.segment_count} å€‹è·¯æ®µ)`);
        }
        
        // è¨­ç½®æ­¥é“åœ–å±¤çš„ hover äº’å‹• (å·²ç¦ç”¨)
        function setupTrailLayerInteraction_disabled(layerId, trail) {
            if (!trail.path_data || trail.path_data.length === 0) return;
            
            // å‰µå»º tooltip å…ƒç´ ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            let tooltip = document.getElementById('elevation-tooltip');
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.id = 'elevation-tooltip';
                tooltip.className = 'elevation-tooltip';
                document.body.appendChild(tooltip);
            }
            
            // è™•ç†é¡¯ç¤ºè³‡è¨Šçš„å‡½æ•¸
            function showTrailPointInfo(e) {
                const mousePoint = [e.lngLat.lng, e.lngLat.lat];
                
                // æ‰¾åˆ°æœ€æ¥è¿‘é¼ æ¨™çš„è·¯å¾‘é»
                let closestIndex = 0;
                let minDistance = Infinity;
                
                trail.path_data.forEach((point, index) => {
                    const dist = Math.sqrt(
                        Math.pow(point.lon - mousePoint[0], 2) + 
                        Math.pow(point.lat - mousePoint[1], 2)
                    );
                    if (dist < minDistance) {
                        minDistance = dist;
                        closestIndex = index;
                    }
                });
                
                const closestPoint = trail.path_data[closestIndex];
                const elevation = closestPoint.elevation || closestPoint.ele || 0;
                
                // è¨ˆç®—è©²é»çš„ç´¯ç©è·é›¢
                let cumulativeDistance = 0;
                for (let i = 1; i <= closestIndex; i++) {
                    const prev = trail.path_data[i - 1];
                    const curr = trail.path_data[i];
                    const dist = calculateDistance(prev.lat, prev.lon, curr.lat, curr.lon);
                    if (dist < 1.0) { // åªè¨ˆç®—å°æ–¼1kmçš„æ®µè½
                        cumulativeDistance += dist;
                    }
                }
                
                // é¡¯ç¤º tooltip
                tooltip.innerHTML = `
                    <div><strong>è·é›¢:</strong> ${cumulativeDistance.toFixed(2)} km</div>
                    <div><strong>é«˜åº¦:</strong> ${Math.round(elevation)} m</div>
                `;
                tooltip.style.display = 'block';
                
                // æ ¹æ“šäº‹ä»¶é¡å‹èª¿æ•´ tooltip ä½ç½®
                const clientX = e.originalEvent.clientX || e.originalEvent.touches?.[0]?.clientX;
                const clientY = e.originalEvent.clientY || e.originalEvent.touches?.[0]?.clientY;
                
                if (clientX && clientY) {
                    tooltip.style.left = (clientX + 10) + 'px';
                    tooltip.style.top = (clientY - 50) + 'px';
                }
                
                // åœ¨åœ°åœ–ä¸Šæ¨™è¨˜è©²é»
                showElevationMarker(closestPoint.lon, closestPoint.lat, elevation);
            }
            
            // æ”¹è®Šé¼ æ¨™æ¨£å¼ï¼ˆæ¡Œé¢ç«¯ï¼‰
            map.on('mouseenter', layerId, () => {
                map.getCanvas().style.cursor = 'pointer';
            });
            
            map.on('mouseleave', layerId, () => {
                map.getCanvas().style.cursor = '';
                tooltip.style.display = 'none';
                removeElevationMarker();
            });
            
            // æ¡Œé¢ç«¯ï¼šé¼ æ¨™ç§»å‹•æ™‚é¡¯ç¤ºè³‡è¨Š
            map.on('mousemove', layerId, showTrailPointInfo);
            
            // ç§»å‹•ç«¯ï¼šé»æ“Šæ­¥é“æ™‚é¡¯ç¤ºè³‡è¨Š
            map.on('click', layerId, showTrailPointInfo);
            
            // ç§»å‹•ç«¯ï¼šè§¸æ‘¸æ­¥é“æ™‚é¡¯ç¤ºè³‡è¨Š
            map.on('touchstart', layerId, showTrailPointInfo);
        }

        function clearTrailLayer() {
            if (currentTrailLayerId && map.getLayer(currentTrailLayerId)) {
                // ç§»é™¤åœ–å±¤äº‹ä»¶ç›£è½å™¨
                map.off('mouseenter', currentTrailLayerId);
                map.off('mouseleave', currentTrailLayerId);
                map.off('mousemove', currentTrailLayerId);
                map.off('click', currentTrailLayerId);
                map.off('touchstart', currentTrailLayerId);
                
                // ç§»é™¤åœ–å±¤
                map.removeLayer(currentTrailLayerId);
                map.removeLayer(`${currentTrailLayerId}-outline`);
            }
            if (currentTrailSourceId && map.getSource(currentTrailSourceId)) {
                map.removeSource(currentTrailSourceId);
            }
            
            // æ¢å¾©é¼ æ¨™æ¨£å¼
            map.getCanvas().style.cursor = '';
            
            currentTrailLayerId = null;
            currentTrailSourceId = null;
            currentTrailData = null;
            
            // æ¸…é™¤é«˜åº¦æ¨™è¨˜å’Œ tooltip
            removeElevationMarker();
            const tooltip = document.getElementById('elevation-tooltip');
            if (tooltip) {
                tooltip.style.display = 'none';
            }
        }

        // è¨ˆç®—å…©é»é–“çš„è·é›¢ï¼ˆå…¬é‡Œï¼‰
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // åœ°çƒåŠå¾‘ï¼ˆå…¬é‡Œï¼‰
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // è¨ˆç®—æ­¥é“çµ±è¨ˆä¿¡æ¯
        function calculateTrailStats(pathData) {
            if (!pathData || pathData.length < 2) {
                return {
                    distance: 0,
                    ascent: 0,
                    descent: 0,
                    elevations: []
                };
            }

            let totalDistance = 0;
            let totalAscent = 0;
            let totalDescent = 0;
            let cumulativeDistance = 0;
            const elevations = [];
            
            // ä½¿ç”¨å¹³æ»‘é«˜åº¦ä¾†è¨ˆç®—ä¸Šå‡ä¸‹é™ï¼ˆéæ¿¾GPSèª¤å·®ï¼‰
            const ELEVATION_THRESHOLD = 20; // é«˜åº¦è®ŠåŒ–é–¾å€¼ï¼ˆç±³ï¼‰ï¼Œéæ¿¾GPSèª¤å·®å’Œå°æ³¢å‹•
            let lastSignificantElevation = pathData[0].elevation || pathData[0].ele || 0;

            for (let i = 0; i < pathData.length; i++) {
                const point = pathData[i];
                const elevation = point.elevation || point.ele || 0;
                
                if (i > 0) {
                    const prevPoint = pathData[i - 1];
                    const prevElevation = prevPoint.elevation || prevPoint.ele || 0;
                    
                    // è¨ˆç®—è·é›¢
                    const distance = calculateDistance(
                        prevPoint.lat, prevPoint.lon,
                        point.lat, point.lon
                    );
                    
                    // åªè¨ˆç®—å°æ–¼1kmçš„æ®µè½ï¼ˆéæ¿¾è·³èºé»ï¼‰
                    if (distance < 1.0) {
                        totalDistance += distance;
                        cumulativeDistance += distance;
                        
                        // è¨ˆç®—çˆ¬å‡/ä¸‹é™ï¼ˆä½¿ç”¨é–¾å€¼éæ¿¾å°æ³¢å‹•ï¼‰
                        const elevDiff = elevation - lastSignificantElevation;
                        if (Math.abs(elevDiff) >= ELEVATION_THRESHOLD) {
                            if (elevDiff > 0) {
                                totalAscent += elevDiff;
                            } else {
                                totalDescent += Math.abs(elevDiff);
                            }
                            lastSignificantElevation = elevation;
                        }
                    }
                }
                
                elevations.push({
                    distance: cumulativeDistance,
                    elevation: elevation
                });
            }

            return {
                distance: totalDistance,
                ascent: totalAscent,
                descent: totalDescent,
                elevations: elevations
            };
        }

        // é¡¯ç¤ºæ­¥é“è³‡è¨Š
        let elevationChart = null;

        // è¨ˆç®—å…©é»ä¹‹é–“çš„è·é›¢ï¼ˆå…¬é‡Œï¼‰- Haversine å…¬å¼
        function haversine_distance(lat1, lon1, lat2, lon2) {
            const R = 6371; // åœ°çƒåŠå¾‘ï¼ˆå…¬é‡Œï¼‰
            const lat1_rad = lat1 * Math.PI / 180;
            const lat2_rad = lat2 * Math.PI / 180;
            const delta_lat = (lat2 - lat1) * Math.PI / 180;
            const delta_lon = (lon2 - lon1) * Math.PI / 180;
            
            const a = Math.sin(delta_lat/2) * Math.sin(delta_lat/2) +
                     Math.cos(lat1_rad) * Math.cos(lat2_rad) *
                     Math.sin(delta_lon/2) * Math.sin(delta_lon/2);
            const c = 2 * Math.asin(Math.sqrt(a));
            
            return R * c;
        }
        
        function displayTrailInfo(trail) {
            try {
                console.log('===== é–‹å§‹é¡¯ç¤ºæ­¥é“è³‡è¨Š =====', trail.trail_name);
                const stats = calculateTrailStats(trail.path_data);
                console.log('çµ±è¨ˆæ•¸æ“š:', stats);
                
                // æ›´æ–°æ¨™é¡Œå’Œçµ±è¨ˆæ•¸æ“š
                document.getElementById('trail-info-title').textContent = trail.trail_name;
                document.getElementById('trail-length-header').textContent = stats.distance.toFixed(2);
                document.getElementById('trail-ascent-header').textContent = Math.round(stats.ascent);
                document.getElementById('trail-descent-header').textContent = Math.round(stats.descent);
                
                // è¨ˆç®—èˆ‡ç”¨æˆ¶çš„è·é›¢ï¼ˆå¦‚æœæœ‰å®šä½ï¼‰
                const distanceSpan = document.getElementById('trail-distance-from-user');
                if (distanceSpan) {
                    const fiveMinutes = 5 * 60 * 1000;
                    const hasRecentPosition = lastKnownPosition && (Date.now() - lastKnownPosition.timestamp < fiveMinutes);
                    
                    if (hasRecentPosition && trail.center_lat && trail.center_lon) {
                        const distKm = haversine_distance(
                            lastKnownPosition.lat, 
                            lastKnownPosition.lon, 
                            trail.center_lat, 
                            trail.center_lon
                        );
                        distanceSpan.textContent = `(è·æ‚¨ç´„ ${distKm.toFixed(1)} km)`;
                    } else {
                        distanceSpan.textContent = '';
                    }
                }
                
                // å…ˆé¡¯ç¤ºè³‡è¨Šæ¡†ï¼ˆé€™æ¨£æ‰èƒ½æ­£ç¢ºç²å–å®¹å™¨å¯¬åº¦ï¼‰
                const panel = document.getElementById('trail-info-panel');
                console.log('è³‡è¨Šæ¡†å…ƒç´ :', panel);
                if (panel) {
                    panel.classList.add('show');
                    panel.classList.remove('minimized');
                    console.log('è³‡è¨Šæ¡†classes:', panel.className);
                    console.log('è³‡è¨Šæ¡†display:', window.getComputedStyle(panel).display);
                }
                
                // éš±è—æœ€å°åŒ–æ§åˆ¶æŒ‰éˆ•
                const minimizedControls = document.getElementById('trail-minimized-controls');
                if (minimizedControls) {
                    minimizedControls.classList.remove('show');
                }
                
                // æ¸…é™¤èˆŠçš„äº‹ä»¶ç¶å®šæ¨™è¨˜
                const canvas = document.getElementById('elevationChart');
                if (canvas) {
                    canvas._interactionBound = false;
                }
                
                // ä½¿ç”¨ requestAnimationFrame ç¢ºä¿ DOM å·²æ›´æ–°å¾Œå†ç¹ªè£½
                requestAnimationFrame(() => {
                    // ç¹ªè£½é«˜åº¦åœ–
                    console.log('æº–å‚™ç¹ªè£½é«˜åº¦åœ–ï¼Œelevationsæ•¸é‡:', stats.elevations.length);
                    drawElevationChart(stats.elevations);
                    
                    // è¨­ç½®é«˜åº¦åœ–äº’å‹•
                    setupElevationChartInteraction();
                });
                
                console.log('===== æ­¥é“è³‡è¨Šé¡¯ç¤ºå®Œæˆ =====');
            } catch (error) {
                console.error('é¡¯ç¤ºæ­¥é“è³‡è¨Šæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            }
        }
        
        // è¨­ç½®é«˜åº¦åœ–äº’å‹•åŠŸèƒ½
        function setupElevationChartInteraction() {
            const canvas = document.getElementById('elevationChart');
            if (!canvas || !canvas.chartData) return;
            
            // å‰µå»º tooltip å…ƒç´ ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            let tooltip = document.getElementById('elevation-tooltip');
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.id = 'elevation-tooltip';
                tooltip.className = 'elevation-tooltip';
                document.body.appendChild(tooltip);
            }
            
            // å¦‚æœå·²ç¶“ç¶å®šéäº‹ä»¶ï¼Œå…ˆç§»é™¤ï¼ˆä½¿ç”¨æ¨™è¨˜ï¼‰
            if (canvas._interactionBound) {
                return; // å·²ç¶“ç¶å®šéäº†ï¼Œä¸é‡è¤‡ç¶å®š
            }
            canvas._interactionBound = true;
            
            const chartCanvas = canvas;
            
            // è™•ç†äº’å‹•çš„å‡½æ•¸
            function handleInteraction(e) {
                e.preventDefault();
                
                if (!chartCanvas.chartData) return;
                
                const rect = chartCanvas.getBoundingClientRect();
                const clientX = e.type.startsWith('touch') ? e.touches[0].clientX : e.clientX;
                const clientY = e.type.startsWith('touch') ? e.touches[0].clientY : e.clientY;
                const x = clientX - rect.left;
                const y = clientY - rect.top;
                
                const data = chartCanvas.chartData;
                const { elevations, paddingLeft, chartWidth, minElev, maxElev, elevRange, maxDist } = data;
                
                // æª¢æŸ¥æ˜¯å¦åœ¨åœ–è¡¨å€åŸŸå…§
                if (x < paddingLeft || x > paddingLeft + chartWidth) {
                    tooltip.style.display = 'none';
                    removeElevationMarker();
                    return;
                }
                
                // è¨ˆç®—å°æ‡‰çš„è·é›¢
                const distanceRatio = (x - paddingLeft) / chartWidth;
                const distance = distanceRatio * maxDist;
                
                // æ‰¾åˆ°æœ€æ¥è¿‘çš„é»
                let closestIndex = 0;
                let minDiff = Math.abs(elevations[0].distance - distance);
                
                for (let i = 1; i < elevations.length; i++) {
                    const diff = Math.abs(elevations[i].distance - distance);
                    if (diff < minDiff) {
                        minDiff = diff;
                        closestIndex = i;
                    }
                }
                
                const point = elevations[closestIndex];
                
                // é¡¯ç¤º tooltip
                tooltip.innerHTML = `
                    <div><strong>è·é›¢:</strong> ${point.distance.toFixed(2)} km</div>
                    <div><strong>é«˜åº¦:</strong> ${Math.round(point.elevation)} m</div>
                `;
                tooltip.style.display = 'block';
                tooltip.style.left = (clientX + 10) + 'px';
                tooltip.style.top = (clientY - 50) + 'px';
                
                // åœ¨åœ°åœ–ä¸Šæ¨™è¨˜è©²é»
                if (currentTrailData && currentTrailData.path_data) {
                    const mapPoint = currentTrailData.path_data[closestIndex];
                    if (mapPoint) {
                        showElevationMarker(mapPoint.lon, mapPoint.lat, point.elevation);
                    }
                }
            }
            
            // éš±è— tooltip å’Œæ¨™è¨˜
            function hideInteraction() {
                tooltip.style.display = 'none';
                removeElevationMarker();
            }
            
            // æ¡Œé¢ç«¯äº‹ä»¶
            chartCanvas.addEventListener('mousemove', handleInteraction);
            chartCanvas.addEventListener('mousedown', handleInteraction);
            chartCanvas.addEventListener('mouseleave', hideInteraction);
            
            // ç§»å‹•ç«¯äº‹ä»¶
            chartCanvas.addEventListener('touchstart', handleInteraction);
            chartCanvas.addEventListener('touchmove', handleInteraction);
            chartCanvas.addEventListener('touchend', hideInteraction);
        }
        
        // åœ¨åœ°åœ–ä¸Šé¡¯ç¤ºé«˜åº¦æ¨™è¨˜
        function showElevationMarker(lon, lat, elevation) {
            removeElevationMarker();
            
            // å‰µå»ºè‡ªå®šç¾©æ¨™è¨˜å…ƒç´ 
            const el = document.createElement('div');
            el.className = 'elevation-marker';
            el.style.cssText = `
                width: 14px;
                height: 14px;
                background: #ff3366;
                border: 3px solid white;
                border-radius: 50%;
                box-shadow: 0 2px 8px rgba(0,0,0,0.5);
                cursor: pointer;
                transition: transform 0.2s;
            `;
            
            // å‰µå»º Markerï¼ˆä¸ä½¿ç”¨ popupï¼Œæ”¹ç”¨ tooltip çµ±ä¸€é¡¯ç¤ºï¼‰
            currentElevationMarker = new maplibregl.Marker({
                element: el,
                anchor: 'center'
            })
            .setLngLat([lon, lat])
            .addTo(map);
        }
        
        // ç§»é™¤é«˜åº¦æ¨™è¨˜
        function removeElevationMarker() {
            if (currentElevationMarker) {
                currentElevationMarker.remove();
                currentElevationMarker = null;
            }
        }

        // ç¹ªè£½é«˜åº¦åœ–è¡¨
        let currentElevationMarker = null;
        
        function drawElevationChart(elevations) {
            const canvas = document.getElementById('elevationChart');
            if (!canvas) {
                console.log('Canvaså…ƒç´ ä¸å­˜åœ¨');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            
            // ç²å–è¨­å‚™åƒç´ æ¯”ç‡ä»¥æ”¯æ´é«˜ DPI è¢å¹•
            const dpr = window.devicePixelRatio || 1;
            
            // ç²å–çˆ¶å®¹å™¨å¯¬åº¦ï¼Œå¦‚æœç‚º0å‰‡ä½¿ç”¨å›ºå®šå¯¬åº¦
            let containerWidth = canvas.parentElement.offsetWidth;
            if (containerWidth === 0) {
                console.log('å®¹å™¨å¯¬åº¦ç‚º0ï¼Œä½¿ç”¨å›ºå®šå¯¬åº¦500px');
                containerWidth = 500;
            }
            
            // é¡¯ç¤ºå°ºå¯¸ï¼ˆCSS åƒç´ ï¼‰
            const displayWidth = containerWidth - 24; // æ¸›å»padding
            // æ ¹æ“šè¢å¹•å¯¬åº¦æ±ºå®šé«˜åº¦
            const displayHeight = window.innerWidth <= 768 ? 90 : 100;
            
            // è¨­ç½® CSS é¡¯ç¤ºå°ºå¯¸
            canvas.style.width = displayWidth + 'px';
            canvas.style.height = displayHeight + 'px';
            
            // è¨­ç½®å¯¦éš›ç¹ªè£½å°ºå¯¸ï¼ˆè€ƒæ…®è¨­å‚™åƒç´ æ¯”ï¼‰
            canvas.width = displayWidth * dpr;
            canvas.height = displayHeight * dpr;
            
            // ç¸®æ”¾ç¹ªåœ–ä¸Šä¸‹æ–‡ä»¥åŒ¹é…è¨­å‚™åƒç´ æ¯”
            ctx.scale(dpr, dpr);
            
            console.log('Canvaså°ºå¯¸ - é¡¯ç¤º:', displayWidth, 'x', displayHeight, 'å¯¦éš›:', canvas.width, 'x', canvas.height, 'DPR:', dpr);
            
            if (elevations.length < 2) {
                ctx.fillStyle = '#2c3e50';
                ctx.font = 'bold 12px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('ç„¡é«˜åº¦è³‡æ–™', displayWidth / 2, displayHeight / 2);
                return;
            }
            
            // æ¸…ç©ºç•«å¸ƒ
            ctx.clearRect(0, 0, displayWidth, displayHeight);
            
            // æ‰¾å‡ºé«˜åº¦ç¯„åœ
            const elevs = elevations.map(e => e.elevation);
            const minElev = Math.min(...elevs);
            const maxElev = Math.max(...elevs);
            const elevRange = maxElev - minElev || 1;
            
            // æ‰¾å‡ºè·é›¢ç¯„åœ
            const maxDist = elevations[elevations.length - 1].distance;
            
            console.log('é«˜åº¦ç¯„åœ:', minElev, '-', maxElev, 'è·é›¢:', maxDist.toFixed(2), 'km');
            
            // ç¹ªè£½åƒæ•¸ï¼ˆå¢åŠ å·¦å´ padding ä»¥é¿å…æ•¸å­—è¢«æ“‹ï¼‰
            const paddingLeft = 45;
            const paddingRight = 35;
            const chartWidth = displayWidth - paddingLeft - paddingRight;
            const chartHeight = displayHeight - 35 - 18;
            
            // ç¹ªè£½ç¶²æ ¼å’Œè»¸ç·š
            ctx.strokeStyle = '#d0d0d0';
            ctx.lineWidth = 1;
            
            // ç¹ªè£½æ°´å¹³ç¶²æ ¼ç·šï¼ˆ3æ¢ï¼‰
            for (let i = 0; i <= 2; i++) {
                const y = 35 + (chartHeight / 2) * i;
                ctx.beginPath();
                ctx.moveTo(paddingLeft, y);
                ctx.lineTo(paddingLeft + chartWidth, y);
                ctx.stroke();
                
                // æ·»åŠ é«˜åº¦æ¨™ç±¤
                const elev = maxElev - (elevRange / 2) * i;
                ctx.fillStyle = '#2c3e50';
                ctx.font = 'bold 11px sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(Math.round(elev) + 'm', paddingLeft - 5, y + 4);
            }
            
            // ç¹ªè£½é«˜åº¦ç·š
            ctx.beginPath();
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 3;
            
            elevations.forEach((point, index) => {
                const x = paddingLeft + (point.distance / maxDist) * chartWidth;
                const y = 35 + chartHeight - ((point.elevation - minElev) / elevRange) * chartHeight;
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            
            ctx.stroke();
            
            // ç¹ªè£½å¡«å……å€åŸŸ
            ctx.lineTo(paddingLeft + chartWidth, 35 + chartHeight);
            ctx.lineTo(paddingLeft, 35 + chartHeight);
            ctx.closePath();
            ctx.fillStyle = 'rgba(102, 126, 234, 0.15)';
            ctx.fill();
            
            // æ·»åŠ è·é›¢æ¨™ç±¤ï¼ˆXè»¸ï¼Œåªé¡¯ç¤ºèµ·é»å’Œçµ‚é»ï¼‰
            ctx.fillStyle = '#2c3e50';
            ctx.font = 'bold 11px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText('0km', paddingLeft, displayHeight - 5);
            ctx.textAlign = 'right';
            ctx.fillText(maxDist.toFixed(1) + 'km', paddingLeft + chartWidth, displayHeight - 5);
            
            console.log('é«˜åº¦åœ–è¡¨ç¹ªè£½å®Œæˆ');
            
            // å„²å­˜ç¹ªè£½åƒæ•¸ä¾›äº’å‹•ä½¿ç”¨
            canvas.chartData = {
                elevations,
                paddingLeft,
                paddingRight,
                chartWidth,
                chartHeight,
                displayWidth,
                displayHeight,
                minElev,
                maxElev,
                elevRange,
                maxDist
            };
        }

        // è³‡è¨Šæ¡†æ§åˆ¶å‡½æ•¸
        function minimizeTrailPanel(event) {
            event.stopPropagation();
            const panel = document.getElementById('trail-info-panel');
            
            panel.classList.remove('show');
            panel.classList.add('minimized');
            
            // é¡¯ç¤ºæœ€å°åŒ–æ§åˆ¶æŒ‰éˆ•
            document.getElementById('trail-minimized-controls').classList.add('show');
            
            // éš±è— tooltip å’Œé«˜åº¦æ¨™è¨˜
            const tooltip = document.getElementById('elevation-tooltip');
            if (tooltip) {
                tooltip.style.display = 'none';
            }
            removeElevationMarker();
        }

        function restoreTrailPanel() {
            const panel = document.getElementById('trail-info-panel');
            panel.classList.add('show');
            panel.classList.remove('minimized');
            
            // éš±è—æœ€å°åŒ–æ§åˆ¶æŒ‰éˆ•
            document.getElementById('trail-minimized-controls').classList.remove('show');
        }

        function closeTrailPanel(event) {
            event.stopPropagation();
            
            // é—œé–‰è³‡è¨Šæ¡†
            const panel = document.getElementById('trail-info-panel');
            panel.classList.remove('show');
            panel.classList.remove('minimized');
            
            // éš±è—æœ€å°åŒ–æ§åˆ¶æŒ‰éˆ•
            document.getElementById('trail-minimized-controls').classList.remove('show');
            
            // éš±è—åˆ†äº«æŒ‰éˆ•å’Œå®šä½æŒ‰éˆ•
            const shareBtn = document.getElementById('share-trail-btn');
            if (shareBtn) {
                shareBtn.style.display = 'none';
            }
            
            const centerBtn = document.getElementById('trail-center-btn');
            if (centerBtn) {
                centerBtn.style.display = 'none';
            }
            
            // éš±è—å°èˆªæŒ‰éˆ•ä¸¦æ¸…ç©ºç‹€æ…‹
            hideTrailNavigationButtons();
            currentTrailsList = [];
            currentTrailIndex = -1;
            currentTagSlug = '';
            
            // éš±è—ä¸‹è¼‰æŒ‰éˆ•
            const downloadBtn = document.getElementById('download-gpx-btn');
            if (downloadBtn) {
                downloadBtn.style.display = 'none';
            }
            
            // éš±è— tooltip
            const tooltip = document.getElementById('elevation-tooltip');
            if (tooltip) {
                tooltip.style.display = 'none';
            }
            
            // æ¸…é™¤é«˜åº¦æ¨™è¨˜
            removeElevationMarker();
            
            // æ¸…é™¤æ­¥é“åœ–å±¤
            clearTrailLayer();
            
            // æ¸…é™¤ URL ä¸­çš„æ­¥é“åƒæ•¸
            currentTrailId = null;
            currentTrailName = null;
            currentIsTemporary = false;
            const newUrl = window.location.pathname;
            window.history.pushState({}, '', newUrl);
        }

        function closeTrailPanelCompletely() {
            const panel = document.getElementById('trail-info-panel');
            
            // å®Œå…¨é—œé–‰ï¼ŒåŒ…æ‹¬æœ€å°åŒ–æŒ‰éˆ•
            panel.classList.remove('show');
            document.getElementById('trail-minimized-controls').classList.remove('show');
            
            // éš±è—åˆ†äº«æŒ‰éˆ•å’Œå®šä½æŒ‰éˆ•
            const shareBtn = document.getElementById('share-trail-btn');
            if (shareBtn) {
                shareBtn.style.display = 'none';
            }
            
            const centerBtn = document.getElementById('trail-center-btn');
            if (centerBtn) {
                centerBtn.style.display = 'none';
            }
            
            // éš±è—ä¸‹è¼‰æŒ‰éˆ•
            const downloadBtn = document.getElementById('download-gpx-btn');
            if (downloadBtn) {
                downloadBtn.style.display = 'none';
            }
            
            // éš±è— tooltip
            const tooltip = document.getElementById('elevation-tooltip');
            if (tooltip) {
                tooltip.style.display = 'none';
            }
            
            // æ¸…é™¤é«˜åº¦æ¨™è¨˜
            removeElevationMarker();
            
            // æ¸…é™¤æ­¥é“åœ–å±¤
            clearTrailLayer();
            
            // éš±è—å°èˆªæŒ‰éˆ•ä¸¦æ¸…ç©ºç‹€æ…‹
            hideTrailNavigationButtons();
            currentTrailsList = [];
            currentTrailIndex = -1;
            currentTagSlug = '';
            
            // æ¸…é™¤ URL ä¸­çš„æ­¥é“åƒæ•¸
            currentTrailId = null;
            currentTrailName = null;
            currentIsTemporary = false;
            const newUrl = window.location.pathname;
            window.history.pushState({}, '', newUrl);
        }
        
        // å®šä½å›è·¯ç·šä¸­å¿ƒåŠŸèƒ½
        window.centerMapOnTrail = function() {
            if (!currentTrailBounds) {
                alert('ç„¡æ³•å®šä½åˆ°è·¯ç·š');
                return;
            }
            
            if (currentTrailBounds.type === 'bounds') {
                // ä½¿ç”¨é‚Šç•Œæ¡†
                map.fitBounds(currentTrailBounds.bounds, {
                    padding: {top: 50, bottom: 250, left: 50, right: 50},
                    duration: 1000,
                    maxZoom: 14
                });
            } else if (currentTrailBounds.type === 'center') {
                // ä½¿ç”¨ä¸­å¿ƒé»
                map.flyTo({
                    center: currentTrailBounds.center,
                    zoom: currentTrailBounds.zoom,
                    duration: 1000
                });
            }
        };
        
        // åˆ†äº«æ­¥é“åŠŸèƒ½
        window.shareTrail = function() {
            if (!currentTrailId) {
                alert('ç›®å‰æ²’æœ‰è¼‰å…¥æ­¥é“');
                return;
            }
            
            // å»ºç«‹åˆ†äº« URLï¼ˆä½¿ç”¨æ­¥é“ IDï¼‰
            const shareUrl = `${window.location.origin}${window.location.pathname}?trail_id=${currentTrailId}`;
            
            // è¤‡è£½åˆ°å‰ªè²¼ç°¿
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(shareUrl)
                    .then(() => {
                        showShareToast();
                    })
                    .catch(err => {
                        console.error('è¤‡è£½å¤±æ•—:', err);
                        // é™ç´šæ–¹æ¡ˆï¼šä½¿ç”¨å‚³çµ±æ–¹æ³•
                        fallbackCopyTextToClipboard(shareUrl);
                    });
            } else {
                // é™ç´šæ–¹æ¡ˆï¼šä½¿ç”¨å‚³çµ±æ–¹æ³•
                fallbackCopyTextToClipboard(shareUrl);
            }
        };
        
        // é™ç´šè¤‡è£½æ–¹æ³•ï¼ˆé©ç”¨æ–¼èˆŠç€è¦½å™¨ï¼‰
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.top = '0';
            textArea.style.left = '0';
            textArea.style.opacity = '0';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showShareToast();
                } else {
                    alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ï¼š\n' + text);
                }
            } catch (err) {
                alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ï¼š\n' + text);
            }
            
            document.body.removeChild(textArea);
        }
        
        // é¡¯ç¤ºåˆ†äº«æˆåŠŸæç¤º
        function showShareToast() {
            const toast = document.getElementById('share-toast');
            if (toast) {
                toast.classList.add('show');
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 2000);
            }
        }


        // æ¡Œé¢ç«¯è¼¸å…¥è‡ªå‹•æœç´¢ï¼ˆé˜²æŠ– 300msï¼‰
        const desktopInput = document.getElementById('peak-search-input');
        if (desktopInput) {
            const debouncedSearch = debounce(() => {
                searchPeaks();
            }, 300);
            
            desktopInput.addEventListener('input', debouncedSearch);
            
            desktopInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    searchPeaks();
                }
            });
        }

        // ç§»åŠ¨ç«¯è¼¸å…¥è‡ªå‹•æœç´¢ï¼ˆé˜²æŠ– 300msï¼‰
        const mobileInput = document.getElementById('mobile-peak-search-input');
        if (mobileInput) {
            const debouncedSearchMobile = debounce(() => {
                searchPeaksMobile();
            }, 300);
            
            mobileInput.addEventListener('input', debouncedSearchMobile);
            
            mobileInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    searchPeaksMobile();
                }
            });
        }

        // ============================================
        // ä¸Šå‚³è»Œè·¡åŠŸèƒ½
        // ============================================
        
        // é¡¯ç¤ºä¸Šå‚³å°è©±æ¡†
        window.showUploadDialog = function() {
            document.getElementById('upload-dialog').style.display = 'flex';
            // é‡ç½®è¡¨å–®
            document.getElementById('upload-trail-form').reset();
        };
        
        // è™•ç†ä¸Šå‚³è¡¨å–®æäº¤
        window.handleTrailUpload = async function(event) {
            event.preventDefault();
            
            const submitBtn = document.getElementById('upload-submit-btn');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'ä¸Šå‚³ä¸­...';
            
            const formData = new FormData(event.target);
            
            try {
                const response = await fetch('/api/trail/upload/', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // é—œé–‰ä¸Šå‚³å°è©±æ¡†
                    closeDialog('upload-dialog');
                    
                    // é¡¯ç¤ºæˆåŠŸå°è©±æ¡†
                    showUploadSuccessDialog(result);
                } else {
                    alert('ä¸Šå‚³å¤±æ•—ï¼š' + (result.error || 'æœªçŸ¥éŒ¯èª¤'));
                }
            } catch (error) {
                console.error('ä¸Šå‚³éŒ¯èª¤:', error);
                alert('ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥å¾Œé‡è©¦');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        };
        
        // é¡¯ç¤ºä¸Šå‚³æˆåŠŸå°è©±æ¡†
        function showUploadSuccessDialog(result) {
            const content = document.getElementById('upload-success-content');
            let html = '<div class="success-icon">âœ…</div>';
            
            if (result.temporary_trail) {
                const temp = result.temporary_trail;
                const shareUrl = `${window.location.origin}${window.location.pathname}?temp_trail=${temp.trail_id}`;
                
                html += `
                    <h3 style="text-align: center; margin: 0;">è‡¨æ™‚åˆ†äº«é€£çµå·²ç”¢ç”Ÿ</h3>
                    <div class="share-url-box" id="temp-share-url">${shareUrl}</div>
                    <button class="btn-primary" onclick="copyTempShareUrl()" style="width: 100%; padding: 16px; font-size: 16px; font-weight: 700;">
                        ğŸ“‹ è¤‡è£½åˆ†äº«é€£çµ
                    </button>
                    <div class="expiry-notice">
                        â° æ­¤é€£çµå°‡åœ¨ <strong>${temp.days_until_expiry} å¤©å¾Œ</strong>è‡ªå‹•å¤±æ•ˆï¼ˆ${new Date(temp.expires_at).toLocaleDateString('zh-TW')}ï¼‰
                    </div>
                `;
            }
            
            if (result.pending_trail) {
                html += `
                    <div style="padding: 12px; background: #e3f2fd; border: 1px solid #2196f3; border-radius: 6px; margin-top: 10px;">
                        <p style="margin: 0; color: #1565c0; font-size: 14px;">
                            âœ“ æ‚¨çš„æ­¥é“å·²æäº¤å¯©æ ¸<br>
                            å¯©æ ¸é€šéå¾Œå°‡æ°¸ä¹…æ”¶éŒ„åœ¨åœ°åœ–ä¸­
                        </p>
                    </div>
                `;
                
                if (result.temporary_trail) {
                    html += `
                        <p style="text-align: center; font-size: 13px; color: #666; margin: 10px 0 0 0;">
                            åœ¨å¯©æ ¸æœŸé–“ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä¸Šæ–¹çš„è‡¨æ™‚åˆ†äº«é€£çµ
                        </p>
                    `;
                }
            }
            
            content.innerHTML = html;
            document.getElementById('upload-success-dialog').style.display = 'flex';
        }
        
        // è¤‡è£½è‡¨æ™‚åˆ†äº«é€£çµ
        window.copyTempShareUrl = function() {
            const urlText = document.getElementById('temp-share-url').textContent;
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(urlText)
                    .then(() => {
                        showShareToast();
                    })
                    .catch(err => {
                        console.error('è¤‡è£½å¤±æ•—:', err);
                        fallbackCopyTextToClipboard(urlText);
                    });
            } else {
                fallbackCopyTextToClipboard(urlText);
            }
        };

        // ============================================
        // URL åƒæ•¸è™•ç†ï¼šé é¢è¼‰å…¥æ™‚è‡ªå‹•è¼‰å…¥æ­¥é“
        // ============================================
        function loadTrailFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const trailId = urlParams.get('trail_id');
            const tempTrailId = urlParams.get('temp_trail');
            const pendingTrailId = urlParams.get('pending_trail');
            
            // æª¢æŸ¥æ˜¯å¦ç‚ºè‡¨æ™‚åˆ†äº«
            if (tempTrailId) {
                loadTemporaryTrail(tempTrailId);
                return;
            }
            
            // æª¢æŸ¥æ˜¯å¦ç‚ºå¾…å¯©æ ¸æ­¥é“
            if (pendingTrailId) {
                loadPendingTrail(pendingTrailId);
                return;
            }
            
            // æ­£å¼æ­¥é“ - ä½¿ç”¨ trail_id
            if (trailId) {
                // ç›´æ¥ä½¿ç”¨ trail_id è¼‰å…¥
                loadAndDisplayTrail(parseInt(trailId), null, false);
            }
        }
        
        // è¼‰å…¥è‡¨æ™‚åˆ†äº«æ­¥é“
        function loadTemporaryTrail(tempTrailId) {
            fetch(`/api/temp_trail/${tempTrailId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.trail) {
                        const trail = data.trail;
                        currentTrailData = trail;
                        currentTrailId = trail.trail_id;
                        currentTrailName = trail.trail_name;
                        currentIsTemporary = true;
                        
                        displayTrailOnMap(trail);
                        displayTrailInfo(trail);
                        
                        // é¡¯ç¤ºåˆ†äº«æŒ‰éˆ•å’Œä¸‹è¼‰æŒ‰éˆ•
                        const shareBtn = document.getElementById('share-trail-btn');
                        if (shareBtn) {
                            shareBtn.style.display = 'inline-flex';
                        }
                        
                        const downloadBtn = document.getElementById('download-gpx-btn');
                        if (downloadBtn) {
                            downloadBtn.style.display = 'inline-flex';
                        }
                        
                        // é¡¯ç¤ºå®šä½å›è·¯ç·šæŒ‰éˆ•
                        const centerBtn = document.getElementById('trail-center-btn');
                        if (centerBtn) {
                            centerBtn.style.display = 'inline-flex';
                        }
                        
                        // ä½¿ç”¨é‚Šç•Œæ¡†è‡ªå‹•ç¸®æ”¾ï¼Œä¸¦å­˜å„²é‚Šç•Œè³‡è¨Š
                        if (trail.bounds && trail.bounds.min_lat && trail.bounds.max_lat) {
                            const bounds = [
                                [trail.bounds.min_lon, trail.bounds.min_lat],
                                [trail.bounds.max_lon, trail.bounds.max_lat]
                            ];
                            currentTrailBounds = { bounds: bounds, type: 'bounds' };
                            
                            map.fitBounds(bounds, {
                                padding: {top: 50, bottom: 250, left: 50, right: 50},  // åº•éƒ¨å¢åŠ  padding è®“æ­¥é“ä¸Šç§»
                                duration: 1500,
                                maxZoom: 14
                            });
                        } else if (trail.center_lat && trail.center_lon) {
                            currentTrailBounds = { 
                                center: [trail.center_lon, trail.center_lat], 
                                zoom: 13,
                                type: 'center' 
                            };
                            map.flyTo({
                                center: [trail.center_lon, trail.center_lat],
                                zoom: 13,
                                duration: 1500
                            });
                        }
                    } else {
                        alert('æ‰¾ä¸åˆ°æ­¤è‡¨æ™‚åˆ†äº«æ­¥é“ï¼Œå¯èƒ½å·²éæœŸ');
                    }
                })
                .catch(error => {
                    console.error('è¼‰å…¥è‡¨æ™‚æ­¥é“å¤±æ•—:', error);
                    alert('è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                });
        }
        
        // è¼‰å…¥å¾…å¯©æ ¸æ­¥é“ï¼ˆåƒ…ç®¡ç†å“¡ï¼‰
        function loadPendingTrail(pendingTrailId) {
            fetch(`/api/pending_trail/${pendingTrailId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.trail) {
                        const trail = data.trail;
                        currentTrailData = trail;
                        currentTrailId = trail.pending_id;
                        currentTrailName = trail.trail_name;
                        currentIsTemporary = false;
                        
                        displayTrailOnMap(trail);
                        displayTrailInfo(trail);
                        
                        // å¾…å¯©æ ¸æ­¥é“ä¸é¡¯ç¤ºåˆ†äº«å’Œä¸‹è¼‰æŒ‰éˆ•
                        const shareBtn = document.getElementById('share-trail-btn');
                        if (shareBtn) {
                            shareBtn.style.display = 'none';
                        }
                        
                        const downloadBtn = document.getElementById('download-gpx-btn');
                        if (downloadBtn) {
                            downloadBtn.style.display = 'none';
                        }
                        
                        // é¡¯ç¤ºå®šä½å›è·¯ç·šæŒ‰éˆ•ï¼ˆå¾…å¯©æ ¸æ­¥é“ä¹Ÿå¯ä»¥ç”¨ï¼‰
                        const centerBtn = document.getElementById('trail-center-btn');
                        if (centerBtn) {
                            centerBtn.style.display = 'inline-flex';
                        }
                        
                        // ä¿®æ”¹æ¨™é¡Œé¡¯ç¤ºç‚ºã€Œå¾…å¯©æ ¸ã€
                        const titleElement = document.getElementById('trail-info-title');
                        if (titleElement) {
                            titleElement.innerHTML = `${trail.trail_name} <span style="background: #ff9800; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin-left: 8px;">å¾…å¯©æ ¸</span>`;
                        }
                        
                        // ä½¿ç”¨é‚Šç•Œæ¡†è‡ªå‹•ç¸®æ”¾ï¼Œä¸¦å­˜å„²é‚Šç•Œè³‡è¨Š
                        if (trail.bounds && trail.bounds.min_lat && trail.bounds.max_lat) {
                            const bounds = [
                                [trail.bounds.min_lon, trail.bounds.min_lat],
                                [trail.bounds.max_lon, trail.bounds.max_lat]
                            ];
                            currentTrailBounds = { bounds: bounds, type: 'bounds' };
                            
                            map.fitBounds(bounds, {
                                padding: {top: 50, bottom: 250, left: 50, right: 50},  // åº•éƒ¨å¢åŠ  padding è®“æ­¥é“ä¸Šç§»
                                duration: 1500,
                                maxZoom: 14
                            });
                        } else if (trail.center_lat && trail.center_lon) {
                            currentTrailBounds = { 
                                center: [trail.center_lon, trail.center_lat], 
                                zoom: 13,
                                type: 'center' 
                            };
                            map.flyTo({
                                center: [trail.center_lon, trail.center_lat],
                                zoom: 13,
                                duration: 1500
                            });
                        }
                    } else {
                        alert(data.error || 'æ‰¾ä¸åˆ°æ­¤å¾…å¯©æ ¸æ­¥é“');
                    }
                })
                .catch(error => {
                    console.error('è¼‰å…¥å¾…å¯©æ ¸æ­¥é“å¤±æ•—:', error);
                    alert('è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªæ‚¨æœ‰ç®¡ç†å“¡æ¬Šé™');
                });
        }
        
        // ä¸‹è¼‰æ­¥é“ GPX æª”æ¡ˆ
        window.downloadTrailGPX = function() {
            if (!currentIsTemporary || !currentTrailId) {
                alert('åªæœ‰è‡¨æ™‚åˆ†äº«æ­¥é“å¯ä»¥ä¸‹è¼‰ GPX æª”æ¡ˆ');
                return;
            }
            
            // ç›´æ¥å°å‘ä¸‹è¼‰ URL
            window.location.href = `/api/temp_trail/${currentTrailId}/download/`;
        };

        // ç€è¦½å™¨å‰å¾Œé æ”¯æ´
        window.addEventListener('popstate', function(event) {
            if (event.state && event.state.trailId) {
                // ç”¨æˆ¶é»æ“Šäº†ã€Œä¸Šä¸€é ã€å›åˆ°æœ‰æ­¥é“çš„ç‹€æ…‹
                loadAndDisplayTrail(event.state.trailId, event.state.trailName, false);
            } else {
                // ç”¨æˆ¶é»æ“Šäº†ã€Œä¸Šä¸€é ã€å›åˆ°æ²’æœ‰æ­¥é“çš„ç‹€æ…‹
                const urlParams = new URLSearchParams(window.location.search);
                const trailId = urlParams.get('trail_id');
                const tempTrailId = urlParams.get('temp_trail');
                const pendingTrailId = urlParams.get('pending_trail');
                
                if (tempTrailId || pendingTrailId || trailId) {
                    loadTrailFromUrl();
                } else {
                    // æ¸…é™¤æ­¥é“é¡¯ç¤º
                    closeTrailPanelCompletely();
                }
            }
        });

        // é é¢è¼‰å…¥å®Œæˆå¾Œæª¢æŸ¥ URL åƒæ•¸
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadTrailFromUrl);
        } else {
            // DOMContentLoaded å·²ç¶“è§¸ç™¼éäº†
            loadTrailFromUrl();
        }

        // ========== æ¢ç´¢åŠŸèƒ½ï¼šç™¾å²³/å°ç™¾å²³ ==========
        
        let currentTrailsList = [];
        let currentTrailIndex = -1;
        let currentTagSlug = '';
        let currentPage = 1;
        let itemsPerPage = 10;
        let totalPages = 1;
        
        // åˆ‡æ›ç§»å‹•ç«¯æ¢ç´¢ä¸‹æ‹‰é¸å–®
        window.toggleMobileExploreDropdown = function() {
            const dropdown = document.getElementById('mobile-explore-dropdown');
            dropdown.classList.toggle('show');
        };
        
        // é»æ“Šå…¶ä»–åœ°æ–¹é—œé–‰ä¸‹æ‹‰é¸å–®
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('mobile-explore-dropdown');
            const btn = document.querySelector('.mobile-explore-btn');
            if (dropdown && !dropdown.contains(e.target) && e.target !== btn) {
                dropdown.classList.remove('show');
            }
        });
        
        // é¡¯ç¤ºé™„è¿‘æ­¥é“å°è©±æ¡†ï¼ˆå„ªå…ˆä½¿ç”¨å·²æœ‰å®šä½ï¼‰
        window.showNearbyTrailsDialog = function() {
            const dialog = document.getElementById('trails-list-dialog');
            const title = document.getElementById('trails-dialog-title');
            const content = document.getElementById('trails-list-content');
            
            dialog.style.display = 'flex';
            title.textContent = 'é™„è¿‘æ­¥é“';
            
            // æª¢æŸ¥æ˜¯å¦æœ‰æœ€è¿‘çš„å®šä½ï¼ˆ5 åˆ†é˜å…§ï¼‰
            const fiveMinutes = 5 * 60 * 1000;
            const hasRecentPosition = lastKnownPosition && (Date.now() - lastKnownPosition.timestamp < fiveMinutes);
            
            if (hasRecentPosition) {
                // ç›´æ¥ä½¿ç”¨å·²æœ‰å®šä½
                content.innerHTML = '<div style="text-align: center; padding: 40px;"><p>è¼‰å…¥ä¸­...</p></div>';
                fetchNearbyTrails(lastKnownPosition.lat, lastKnownPosition.lon);
                return;
            }
            
            // éœ€è¦é‡æ–°å–å¾—å®šä½
            content.innerHTML = '<div style="text-align: center; padding: 40px;"><p>å–å¾—å®šä½ä¸­...</p></div>';
            
            if (!navigator.geolocation) {
                content.innerHTML = '<div style="text-align: center; padding: 40px; color: #e53935;">æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½</div>';
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const lat = pos.coords.latitude;
                    const lon = pos.coords.longitude;
                    lastKnownPosition = { lat, lon, timestamp: Date.now() };
                    fetchNearbyTrails(lat, lon);
                },
                (err) => {
                    let msg = 'ç„¡æ³•å–å¾—å®šä½';
                    if (err.code === 1) msg = 'å·²æ‹’çµ•å®šä½æ¬Šé™';
                    else if (err.code === 2) msg = 'å®šä½å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯';
                    else if (err.code === 3) msg = 'å®šä½é€¾æ™‚ï¼Œè«‹ç¨å¾Œé‡è©¦';
                    content.innerHTML = `<div style="text-align: center; padding: 40px; color: #e53935;">${msg}</div>`;
                },
                { enableHighAccuracy: false, timeout: 15000, maximumAge: 300000 }
            );
        };
        
        // å–å¾—é™„è¿‘æ­¥é“è³‡æ–™
        function fetchNearbyTrails(lat, lon) {
            const content = document.getElementById('trails-list-content');
            const title = document.getElementById('trails-dialog-title');
            
            fetch(`/api/nearby_trails/?lat=${lat}&lon=${lon}&limit=10`)
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        currentTrailsList = data.trails;
                        currentTrailIndex = -1;
                        currentTagSlug = 'nearby';
                        currentPage = 1;
                        title.textContent = `${data.tag.name} (${data.count} æ¢)`;
                        totalPages = Math.ceil(data.count / itemsPerPage);
                        if (data.count === 0) {
                            content.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">é™„è¿‘æ²’æœ‰æ­¥é“</div>';
                            document.getElementById('trails-pagination').style.display = 'none';
                        } else {
                            renderTrailsList();
                            const pagination = document.getElementById('trails-pagination');
                            pagination.style.display = totalPages > 1 ? 'flex' : 'none';
                            if (totalPages > 1) updatePaginationButtons();
                        }
                    } else {
                        content.innerHTML = `<div style="text-align: center; padding: 40px; color: #e53935;">${data.error || 'è¼‰å…¥å¤±æ•—'}</div>`;
                    }
                })
                .catch(err => {
                    console.error(err);
                    content.innerHTML = '<div style="text-align: center; padding: 40px; color: #e53935;">è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦</div>';
                });
        }
        
        // é¡¯ç¤ºè·¯ç·šåˆ—è¡¨å°è©±æ¡†
        window.showTrailsDialog = function(tagSlug) {
            const perfStart = performance.now();
            
            currentTagSlug = tagSlug;
            currentPage = 1;
            const dialog = document.getElementById('trails-list-dialog');
            const title = document.getElementById('trails-dialog-title');
            const content = document.getElementById('trails-list-content');
            
            // é¡¯ç¤ºè¼‰å…¥ä¸­
            content.innerHTML = '<div style="text-align: center; padding: 40px;"><p>è¼‰å…¥ä¸­...</p></div>';
            dialog.style.display = 'flex';
            
            const fetchStart = performance.now();
            
            // ç²å–æ¨™ç±¤è·¯ç·š
            fetch(`/api/tag/${tagSlug}/trails/`)
                .then(response => {
                    const fetchEnd = performance.now();
                    console.log(`ğŸŒ API è«‹æ±‚è€—æ™‚: ${(fetchEnd - fetchStart).toFixed(2)}ms`);
                    return response.json();
                })
                .then(data => {
                    const parseEnd = performance.now();
                    console.log(`ğŸ“Š JSON è§£æè€—æ™‚: ${(parseEnd - fetchStart).toFixed(2)}ms`);
                    
                    if (data.success) {
                        currentTrailsList = data.trails;
                        currentTrailIndex = -1;
                        
                        // æ›´æ–°æ¨™é¡Œ
                        const tagName = data.tag.name;
                        const count = data.count;
                        title.textContent = `${tagName} (${count} æ¢è·¯ç·š)`;
                        
                        // è¨ˆç®—ç¸½é æ•¸
                        totalPages = Math.ceil(count / itemsPerPage);
                        
                        const renderStart = performance.now();
                        
                        // é¡¯ç¤ºè·¯ç·šåˆ—è¡¨
                        if (count === 0) {
                            content.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">ç›®å‰æ²’æœ‰è·¯ç·š</div>';
                            document.getElementById('trails-pagination').style.display = 'none';
                        } else {
                            renderTrailsList();
                            
                            // é¡¯ç¤ºæˆ–éš±è—åˆ†é æ§ä»¶
                            const pagination = document.getElementById('trails-pagination');
                            if (totalPages > 1) {
                                pagination.style.display = 'flex';
                                updatePaginationButtons();
                            } else {
                                pagination.style.display = 'none';
                            }
                        }
                        
                        const renderEnd = performance.now();
                        const totalEnd = performance.now();
                        
                        console.log(`ğŸ¨ å‰ç«¯æ¸²æŸ“è€—æ™‚: ${(renderEnd - renderStart).toFixed(2)}ms`);
                        console.log(`â±ï¸ ç¸½è€—æ™‚: ${(totalEnd - perfStart).toFixed(2)}ms`);
                        console.log(`ğŸ“ è·¯ç·šæ•¸é‡: ${count}`);
                    } else {
                        content.innerHTML = `<div style="text-align: center; padding: 40px; color: #e53935;">è¼‰å…¥å¤±æ•—ï¼š${data.error}</div>`;
                    }
                })
                .catch(error => {
                    console.error('è¼‰å…¥è·¯ç·šåˆ—è¡¨å¤±æ•—:', error);
                    content.innerHTML = '<div style="text-align: center; padding: 40px; color: #e53935;">è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦</div>';
                });
        };
        
        // æ¸²æŸ“è·¯ç·šåˆ—è¡¨ï¼ˆç•¶å‰é ï¼‰
        function renderTrailsList() {
            const content = document.getElementById('trails-list-content');
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, currentTrailsList.length);
            const pageTrails = currentTrailsList.slice(startIndex, endIndex);
            
            let html = '';
            pageTrails.forEach((trail, pageIndex) => {
                const globalIndex = startIndex + pageIndex;
                const stats = trail.stats || {};
                let extra = '';
                
                // é™„è¿‘æ­¥é“ï¼šåŒæ™‚é¡¯ç¤ºè·é›¢èˆ‡é•·åº¦
                if (trail.distance_from_user_km != null) {
                    const distInfo = `è·ç´„${trail.distance_from_user_km}km`;
                    const lengthInfo = stats.distance_km > 0 ? `ğŸ“${stats.distance_km}km` : '';
                    extra = lengthInfo ? `${distInfo}, ${lengthInfo}` : distInfo;
                }
                // å…¶ä»–æ­¥é“ï¼šåªé¡¯ç¤ºé•·åº¦
                else if (stats.distance_km > 0) {
                    extra = `ğŸ“${stats.distance_km}km`;
                }
                
                const displayName = extra ? `${trail.trail_name} (${extra})` : trail.trail_name;
                
                html += `
                    <div class="trail-list-item" onclick="selectTrailFromList(${globalIndex})">
                        <div class="trail-list-item-name">${displayName}</div>
                        <div class="trail-list-item-index">${globalIndex + 1}/${currentTrailsList.length}</div>
                    </div>
                `;
            });
            content.innerHTML = html;
        }
        
        // æ›é 
        window.changePage = function(direction) {
            const newPage = currentPage + direction;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderTrailsList();
                updatePaginationButtons();
                
                // æ»¾å‹•åˆ°é ‚éƒ¨
                const content = document.getElementById('trails-list-content');
                content.scrollTop = 0;
            }
        };
        
        // æ›´æ–°åˆ†é æŒ‰éˆ•ç‹€æ…‹
        function updatePaginationButtons() {
            const prevBtn = document.getElementById('prev-page-btn');
            const nextBtn = document.getElementById('next-page-btn');
            const info = document.getElementById('pagination-info');
            
            if (prevBtn && nextBtn && info) {
                prevBtn.disabled = currentPage <= 1;
                nextBtn.disabled = currentPage >= totalPages;
                info.textContent = `${currentPage} / ${totalPages}`;
            }
        }
        
        // å¾åˆ—è¡¨é¸æ“‡è·¯ç·š
        window.selectTrailFromList = function(index) {
            if (index < 0 || index >= currentTrailsList.length) return;
            
            currentTrailIndex = index;
            const trail = currentTrailsList[index];
            
            // å®šä½åˆ°è·¯ç·š
            loadTrailById(trail.trail_id, trail.trail_name);
            
            // é—œé–‰å°è©±æ¡†ï¼ˆä¸æ“‹ä½åœ°åœ–ï¼‰
            closeTrailsDialog();
            
            // é¡¯ç¤ºæ­¥é“ä¿¡æ¯æ¡†ä¸­çš„å°èˆªæŒ‰éˆ•
            showTrailNavigationButtons();
            updateTrailNavigationButtons();
        };
        
        // å°èˆªåˆ°ä¸Šä¸€æ¢/ä¸‹ä¸€æ¢è·¯ç·šï¼ˆå°è©±æ¡†ä¸­ï¼‰
        window.navigateTrail = function(direction) {
            const newIndex = currentTrailIndex + direction;
            if (newIndex >= 0 && newIndex < currentTrailsList.length) {
                selectTrailFromList(newIndex);
                
                // æ»¾å‹•åˆ°é¸ä¸­çš„é …ç›®
                const items = document.querySelectorAll('.trail-list-item');
                if (items[newIndex]) {
                    items[newIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }
        };
        
        // å°èˆªåˆ°ä¸Šä¸€æ¢/ä¸‹ä¸€æ¢è·¯ç·šï¼ˆä¿¡æ¯æ¡†ä¸­ï¼‰
        window.navigateTrailInPanel = function(direction) {
            const newIndex = currentTrailIndex + direction;
            if (newIndex >= 0 && newIndex < currentTrailsList.length) {
                currentTrailIndex = newIndex;
                const trail = currentTrailsList[newIndex];
                
                // å®šä½åˆ°è·¯ç·š
                loadTrailById(trail.trail_id, trail.trail_name);
                
                // æ›´æ–°ä¿¡æ¯æ¡†ä¸­çš„å°èˆªæŒ‰éˆ•ç‹€æ…‹
                updateTrailNavigationButtons();
            }
        };
        
        // æ›´æ–°å°è©±æ¡†ä¸­çš„å°èˆªæŒ‰éˆ•ç‹€æ…‹
        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prev-trail-btn');
            const nextBtn = document.getElementById('next-trail-btn');
            
            if (prevBtn && nextBtn) {
                prevBtn.disabled = currentTrailIndex <= 0;
                nextBtn.disabled = currentTrailIndex >= currentTrailsList.length - 1;
            }
        }
        
        // é¡¯ç¤ºä¿¡æ¯æ¡†ä¸­çš„å°èˆªæŒ‰éˆ•
        function showTrailNavigationButtons() {
            const prevBtn = document.getElementById('prev-trail-info-btn');
            const nextBtn = document.getElementById('next-trail-info-btn');
            
            if (prevBtn && nextBtn) {
                prevBtn.style.display = 'flex';
                nextBtn.style.display = 'flex';
            }
        }
        
        // éš±è—ä¿¡æ¯æ¡†ä¸­çš„å°èˆªæŒ‰éˆ•
        function hideTrailNavigationButtons() {
            const prevBtn = document.getElementById('prev-trail-info-btn');
            const nextBtn = document.getElementById('next-trail-info-btn');
            
            if (prevBtn && nextBtn) {
                prevBtn.style.display = 'none';
                nextBtn.style.display = 'none';
            }
        }
        
        // æ›´æ–°ä¿¡æ¯æ¡†ä¸­çš„å°èˆªæŒ‰éˆ•ç‹€æ…‹
        function updateTrailNavigationButtons() {
            const prevBtn = document.getElementById('prev-trail-info-btn');
            const nextBtn = document.getElementById('next-trail-info-btn');
            
            if (prevBtn && nextBtn) {
                prevBtn.disabled = currentTrailIndex <= 0;
                nextBtn.disabled = currentTrailIndex >= currentTrailsList.length - 1;
                
                // æ›´æ–°æŒ‰éˆ•é€æ˜åº¦ä»¥ç¤ºç¦ç”¨ç‹€æ…‹
                prevBtn.style.opacity = prevBtn.disabled ? '0.5' : '1';
                nextBtn.style.opacity = nextBtn.disabled ? '0.5' : '1';
                prevBtn.style.cursor = prevBtn.disabled ? 'not-allowed' : 'pointer';
                nextBtn.style.cursor = nextBtn.disabled ? 'not-allowed' : 'pointer';
            }
        }
        
        // é—œé–‰è·¯ç·šåˆ—è¡¨å°è©±æ¡†
        window.closeTrailsDialog = function() {
            const dialog = document.getElementById('trails-list-dialog');
            dialog.style.display = 'none';
            // æ³¨æ„ï¼šä¸æ¸…ç©º currentTrailsList å’Œ currentTrailIndexï¼Œä»¥ä¾¿ä¿¡æ¯æ¡†ä¸­çš„å°èˆªæŒ‰éˆ•ç¹¼çºŒå·¥ä½œ
        };
        
        // éµç›¤å·¦å³éµå°èˆªï¼ˆåƒ…æ¡Œé¢ç‰ˆï¼‰
        document.addEventListener('keydown', function(e) {
            // æª¢æŸ¥æ˜¯å¦æœ‰è·¯ç·šåˆ—è¡¨
            if (currentTrailsList.length === 0) {
                return;
            }
            
            const dialog = document.getElementById('trails-list-dialog');
            const dialogOpen = dialog && dialog.style.display === 'flex';
            
            // å·¦éµï¼šä¸Šä¸€æ¢
            if (e.key === 'ArrowLeft') {
                e.preventDefault();
                if (currentTrailIndex > 0) {
                    if (dialogOpen) {
                        navigateTrail(-1);
                    } else {
                        navigateTrailInPanel(-1);
                    }
                }
            }
            // å³éµï¼šä¸‹ä¸€æ¢
            else if (e.key === 'ArrowRight') {
                e.preventDefault();
                if (currentTrailIndex < currentTrailsList.length - 1) {
                    if (dialogOpen) {
                        navigateTrail(1);
                    } else {
                        navigateTrailInPanel(1);
                    }
                }
            }
            // ESC éµï¼šé—œé–‰å°è©±æ¡†
            else if (e.key === 'Escape' && dialogOpen) {
                closeTrailsDialog();
            }
        });
        
        // æ ¹æ“š trail_id è¼‰å…¥è·¯ç·šï¼ˆè¤‡ç”¨ç¾æœ‰é‚è¼¯ï¼‰
        function loadTrailById(trailId, trailName) {
            // ä½¿ç”¨ç¾æœ‰çš„ loadAndDisplayTrail å‡½æ•¸
            if (window.loadAndDisplayTrail) {
                window.loadAndDisplayTrail(trailId, trailName, false);
            } else {
                console.error('loadAndDisplayTrail å‡½æ•¸æœªå®šç¾©');
            }
        }
    </script>
</body>
</html>
